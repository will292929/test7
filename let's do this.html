<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Visual GitHub Pages Editor</title>
  <style>
.iframe-wrapper {
  position: relative;
  display: inline-block;
  overflow: hidden;
}
.iframe-overlay {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: transparent;
  z-index: 1000;
  cursor: pointer;
}
.edit-backdrop {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.3);
  z-index: 1999;
}
.edit-overlay {
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  border: 1px solid #ccc;
  padding: 20px;
  z-index: 2000;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

  </style>

  <style>
    /* Main document body - only apply to the parent document, not iframe content */
    body:not([data-iframe-content]) {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0 !important;
      padding: 0 !important;
      overflow: hidden;
      background: #ffffff !important;
      min-height: 100vh;
    }
    
    html:not([data-iframe-content]) {
      margin: 0 !important;
      padding: 0 !important;
      background: #ffffff !important;
    }

    /* Explicitly reset iframe content styling to prevent inheritance */
    [data-iframe-content="true"] {
      background: inherit !important;
      color: inherit !important;
      font-family: inherit !important;
      margin: inherit !important;
      padding: inherit !important;
      overflow: inherit !important;
      min-height: inherit !important;
    }

    [data-iframe-content="true"] body {
      background: inherit !important;
      color: inherit !important;
      font-family: inherit !important;
      margin: inherit !important;
      padding: inherit !important;
      overflow: inherit !important;
      min-height: inherit !important;
    }

    [data-iframe-content="true"] html {
      background: inherit !important;
      color: inherit !important;
      font-family: inherit !important;
      margin: inherit !important;
      padding: inherit !important;
      overflow: inherit !important;
      min-height: inherit !important;
    }

    /* Additional isolation for iframe content */
    iframe[data-iframe-content="true"] {
      background: transparent !important;
    }

    /* Prevent any CSS inheritance in iframe */
    #pageFrame {
      background: transparent !important;
    }

    #pageFrame * {
      background: inherit !important;
      color: inherit !important;
    }

    /* Fancy animations */
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes glow {
      0%, 100% { box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3); }
      50% { box-shadow: 0 4px 25px rgba(0, 123, 255, 0.6); }
    }

    @keyframes slideIn {
      from { transform: translateX(100px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes fadeInUp {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    #editor {
      padding: 20px;
      animation: fadeInUp 0.8s ease-out;
      position: relative;
      background: transparent;
    }

    #editor::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: transparent;
      border-radius: 15px;
      z-index: -1;
    }



    #editor iframe {
      width: 100%;
      height: calc(100vh - 60px);
      border: none;
      background: transparent;
      display: block;
    }

    #publishBtn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 16px 24px;
      background: #dc3545;
      color: white;
      border: none;
      font-weight: 700;
      cursor: pointer;
      z-index: 9999;
      box-shadow: 0 10px 30px rgba(220, 53, 69, 0.4);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      width: 130px;
      height: 60px;
      justify-content: center;
      animation: slideIn 0.6s ease-out;
      backdrop-filter: blur(15px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: relative;
      overflow: hidden;
      clip-path: polygon(20% 0%, 80% 0%, 100% 50%, 80% 100%, 20% 100%, 0% 50%);
      transform: rotate(0deg);
    }

    #publishBtn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.6s;
      clip-path: polygon(20% 0%, 80% 0%, 100% 50%, 80% 100%, 20% 100%, 0% 50%);
    }

    #publishBtn:hover::before {
      left: 100%;
    }

    #publishBtn:hover {
      transform: translateY(-4px) scale(1.08) rotate(-3deg);
      box-shadow: 0 15px 40px rgba(220, 53, 69, 0.6);
      background: #e74c3c;
    }

    #publishBtn:active {
      transform: translateY(-2px) scale(0.95) rotate(-7deg);
      box-shadow: 0 8px 25px rgba(220, 53, 69, 0.5);
    }

    #publishBtn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: none;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .commit-status {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 20px 30px;
      border-radius: 12px;
      z-index: 3000;
      text-align: center;
      display: none;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .commit-status .spinner {
      display: inline-block;
      margin-bottom: 15px;
    }

    /* Enhanced status bar with types */
    .status-info {
      background: #000000 !important;
      border: 2px solid #dc3545 !important;
      color: white !important;
      font-weight: 700 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.5px !important;
    }

    .status-success {
      background: #000000 !important;
      border: 2px solid #28a745 !important;
      color: white !important;
      font-weight: 700 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.5px !important;
    }

    .status-warning {
      background: #000000 !important;
      border: 2px solid #ffc107 !important;
      color: white !important;
      font-weight: 700 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.5px !important;
    }

    .status-error {
      background: #000000 !important;
      border: 2px solid #dc3545 !important;
      color: white !important;
      font-weight: 700 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.5px !important;
    }

    /* Quick actions panel */
    .quick-actions {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #000000;
      border-radius: 16px;
      padding: 25px;
      z-index: 2500;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
      border: 2px solid #dc3545;
      max-width: 350px;
      max-height: 70vh;
      text-align: center;
      display: none;
      overflow-y: auto;
      color: white;
    }

    .quick-actions h3 {
      margin: 0 0 20px 0;
      color: #ffffff;
      font-size: 20px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .action-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      margin: 8px 0;
      background: #000000;
      border: 2px solid #dc3545;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      font-weight: 600;
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .action-item:hover {
      border-color: #dc3545;
      background: #dc3545;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
    }

    .action-item .icon {
      margin-right: 12px;
      font-size: 20px;
    }

    /* Progress bar for operations */
    .progress-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 0%;
      height: 3px;
      background: linear-gradient(90deg, #dc3545, #e74c3c);
      z-index: 10000;
      transition: width 0.3s ease;
    }

    /* Floating action button */
    .fab {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #dc3545;
      color: white;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
      transition: all 0.3s ease;
      z-index: 9999;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .fab:hover {
      transform: translateY(-2px) scale(1.1);
      box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
    }

    /* Keyboard shortcuts indicator - commented out to use inline styles */
    /*
    .shortcuts-hint {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 11px;
      z-index: 9999;
      opacity: 0.7;
      transition: opacity 0.3s ease;
    }
    */

    .shortcuts-hint:hover {
      opacity: 1;
    }

    /* Dark mode styles */
    .dark-mode {
      color: #ffffff !important;
    }

    .dark-mode #editor {
      background: #2d2d2d !important;
    }

    .dark-mode .edit-overlay {
      background: linear-gradient(135deg, #2d2d2d, #1a1a1a) !important;
      color: #ffffff !important;
    }

    .dark-mode .edit-overlay input,
    .dark-mode .edit-overlay select,
    .dark-mode .edit-overlay textarea {
      background: #3d3d3d !important;
      color: #ffffff !important;
      border-color: #555 !important;
    }

    .dark-mode .edit-option {
      background: #3d3d3d !important;
      color: #ffffff !important;
      border-color: #555 !important;
    }

    .dark-mode .action-item {
      background: #3d3d3d !important;
      color: #ffffff !important;
      border-color: #555 !important;
    }

    .dark-mode .action-item:hover {
      background: #4d4d4d !important;
      border-color: #007bff !important;
    }

    /* Bulk styling button hover effects */
    #applyToSameBgColor:hover,
    #applyToSameTextColor:hover,
    #applyToSameTag:hover {
      background: #007bff !important;
      color: white !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
    }

    .hover-highlight {
      outline: 2px dashed red;
    }

    .edit-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1900;
      backdrop-filter: blur(8px);
      animation: fadeIn 0.3s ease-out;
    }

    .edit-overlay {
      position: fixed;
      min-width: 420px;
      max-width: 600px;
      max-height: 85vh;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #000000;
      border: none;
      border-radius: 24px;
      padding: 35px;
      z-index: 2100;
      box-shadow: 0 30px 100px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(25px);
      border: 2px solid #dc3545;
      overflow-y: auto;
      overflow-x: hidden;
      animation: fadeIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      color: white;
    }

    .edit-overlay h3 {
      margin: 0 0 20px 0;
      color: #ffffff;
      font-size: 20px;
      font-weight: 700;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .edit-overlay label {
      display: block;
      margin-bottom: 8px;
      color: #ffffff;
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .edit-overlay select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #dc3545;
      border-radius: 8px;
      background: #000000;
      color: #ffffff;
      font-size: 14px;
      margin-bottom: 15px;
      transition: border-color 0.3s ease;
      cursor: pointer;
    }

    .edit-overlay select:focus {
      outline: none;
      border-color: #dc3545;
      box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.3);
    }

    .edit-overlay button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    .edit-overlay button.primary {
      background: transparent;
      color: white;
      border-radius: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      border: 2px solid #dc3545;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .edit-overlay button.primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.6s;
    }

    .edit-overlay button.primary:hover::before {
      left: 100%;
    }

    .edit-overlay button.primary:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
      background: rgba(220, 53, 69, 0.2);
    }

    .edit-overlay button.secondary {
      background: #000000;
      color: white;
      border-radius: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      border: 2px solid #dc3545;
      position: relative;
      overflow: hidden;
    }

    .edit-overlay button.secondary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.6s;
    }

    .edit-overlay button.secondary:hover::before {
      left: 100%;
    }

    .edit-overlay button.secondary:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
      background: #dc3545;
    }

    /* Ensure edit overlay content is clickable */
    .edit-overlay * {
      pointer-events: auto;
    }

    .edit-overlay button {
      position: relative;
      z-index: 2200;
      pointer-events: auto;
    }

    /* Custom scrollbar for edit overlay */
    .edit-overlay::-webkit-scrollbar {
      width: 8px;
    }

    .edit-overlay::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    .edit-overlay::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }

    .edit-overlay::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }

    .edit-overlay input[type="file"] {
      width: 100%;
      padding: 10px;
      border: 2px dashed #dee2e6;
      border-radius: 8px;
      background: #f8f9fa;
      margin-top: 10px;
      cursor: pointer;
    }

    .edit-overlay input[type="file"]:hover {
      border-color: #007bff;
      background: #e3f2fd;
    }

    .edit-overlay input[type="text"],
    .edit-overlay input[type="url"] {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 15px;
      transition: border-color 0.3s ease;
    }

    .edit-overlay input[type="text"]:focus,
    .edit-overlay input[type="url"]:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    .edit-overlay .form-group {
      margin-bottom: 15px;
    }

    .edit-overlay .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #ffffff;
    }

    .edit-overlay .form-group input[type="checkbox"] {
      margin-right: 8px;
      transform: scale(1.2);
    }

    .edit-overlay .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .edit-overlay button.danger {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
    }

    .edit-overlay button.danger:hover {
      background: linear-gradient(135deg, #ff8a8a, #ff6b6b);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
    }

    /* Enhanced Page Selector Styles */
    #pageSelect {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 20px;
      padding-right: 45px !important;
      position: relative;
      z-index: 2;
    }

    #pageSelect:hover {
      border-color: rgba(255, 255, 255, 0.6) !important;
      background: linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0.2)) !important;
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2);
    }

    #pageSelect:focus {
      border-color: #007bff !important;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.3) !important;
      background: linear-gradient(135deg, rgba(255,255,255,0.4), rgba(255,255,255,0.3)) !important;
    }

    #pageSelector:hover {
      transform: none;
      box-shadow: 0 15px 50px rgba(0,0,0,0.6);
      border-color: rgba(255,255,255,0.4);
    }

    /* Fix for upside down text in custom dropdown */
    .custom-dropdown-trigger {
      transform: none !important;
    }

    .custom-dropdown-trigger span {
      transform: none !important;
      writing-mode: horizontal-tb !important;
      text-orientation: mixed !important;
    }

    /* Additional fixes for page selector text orientation */
    #pageSelector {
      transform: none !important;
    }

    #pageSelector * {
      transform: none !important;
      writing-mode: horizontal-tb !important;
      text-orientation: mixed !important;
    }

    #pageSelector span {
      transform: none !important;
      writing-mode: horizontal-tb !important;
      text-orientation: mixed !important;
      direction: ltr !important;
    }

    #selectedPageText {
      transform: none !important;
      writing-mode: horizontal-tb !important;
      text-orientation: mixed !important;
      direction: ltr !important;
      display: inline-block !important;
    }

    /* Enhanced dropdown options styling */
    #pageSelect option {
      background: linear-gradient(135deg, #2c3e50, #34495e);
      color: white;
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 500;
      border: none;
      margin: 2px 0;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    #pageSelect option:hover {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      transform: translateX(5px);
    }

    #pageSelect option:checked {
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
    }

    /* Custom dropdown styling for different browsers */
    #pageSelect::-ms-expand {
      display: none;
    }

    /* Firefox specific styling */
    #pageSelect:-moz-focusring {
      color: transparent;
      text-shadow: 0 0 0 white;
    }

    /* Webkit browsers (Chrome, Safari) */
    #pageSelect::-webkit-select-placeholder {
      color: rgba(255, 255, 255, 0.7);
    }

    #pageSelect:focus {
      border-color: #007bff !important;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2) !important;
      background-color: rgba(255, 255, 255, 0.2) !important;
    }

    #pageSelect option {
      background-color: #2c3e50;
      color: white;
      padding: 8px 12px;
      font-size: 14px;
    }

    #pageSelect option:hover {
      background-color: #34495e;
    }

    #pageSelect option:checked {
      background-color: #007bff;
    }

    .edit-options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }

    .edit-option {
      padding: 20px;
      border: 2px solid #dc3545;
      border-radius: 12px;
      background: #000000;
      color: #ffffff;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      text-align: center;
      font-weight: 700;
      box-shadow: 0 4px 15px rgba(220, 53, 69, 0.2);
      position: relative;
      overflow: hidden;
    }

    .edit-option::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      transition: left 0.5s;
    }

    .edit-option:hover::before {
      left: 100%;
    }

    .edit-option:hover {
      border-color: #dc3545;
      background: #dc3545;
      color: #ffffff;
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
    }

    .edit-option.selected {
      border-color: #dc3545;
      background: #dc3545;
      color: #ffffff;
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
    }

    /* Enhanced element selector options */
    .enhanced-option {
      background: #000000 !important;
      border: 2px solid #dc3545 !important;
      border-radius: 16px !important;
      padding: 25px 20px !important;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
      text-align: center !important;
      font-weight: 700 !important;
      color: #ffffff !important;
      box-shadow: 0 6px 20px rgba(220, 53, 69, 0.2) !important;
      position: relative !important;
      overflow: hidden !important;
      cursor: pointer !important;
      backdrop-filter: blur(10px) !important;
    }

    .enhanced-option::before {
      content: '' !important;
      position: absolute !important;
      top: 0 !important;
      left: -100% !important;
      width: 100% !important;
      height: 100% !important;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent) !important;
      transition: left 0.6s !important;
    }

    .enhanced-option:hover::before {
      left: 100% !important;
    }

    .enhanced-option:hover {
      border-color: #dc3545 !important;
      background: #dc3545 !important;
      color: #ffffff !important;
      transform: translateY(-6px) scale(1.03) !important;
      box-shadow: 0 12px 35px rgba(220, 53, 69, 0.3) !important;
    }

    .enhanced-option.selected {
      border-color: #dc3545 !important;
      background: #dc3545 !important;
      color: #ffffff !important;
      transform: scale(1.08) !important;
      box-shadow: 0 12px 35px rgba(220, 53, 69, 0.4) !important;
    }

    /* Enhanced grid layout */
    .edit-options-grid {
      display: grid !important;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)) !important;
      gap: 12px !important;
      margin-bottom: 20px !important;
    }

    /* Button hover effects */
    #helpBtn:hover, #loremBtn:hover, #undoBtn:hover {
      transform: translateY(-5px) scale(1.1);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
    }

    #helpBtn:hover {
      box-shadow: 0 15px 40px rgba(255, 107, 107, 0.6);
      background: linear-gradient(135deg, #ff8a8a, #ff6b6b);
      animation: pulse 2s infinite;
      transform: translateY(-5px) scale(1.1) rotate(8deg);
    }

    #loremBtn:hover {
      box-shadow: 0 15px 40px rgba(254, 202, 87, 0.6);
      background: linear-gradient(135deg, #ffd93d, #ff9ff3);
      animation: float 2s infinite;
      transform: translateY(-5px) scale(1.1) rotate(-6deg);
    }

    #undoBtn:hover {
      box-shadow: 0 15px 40px rgba(72, 219, 251, 0.6);
      background: linear-gradient(135deg, #6ee7ff, #48dbfb);
      animation: glow 2s infinite;
      transform: translateY(-5px) scale(1.1) rotate(5deg);
    }

    #helpBtn:active, #loremBtn:active, #undoBtn:active {
      transform: translateY(-3px) scale(0.95);
    }

    /* Shimmer effect for all buttons */
    #helpBtn::before, #loremBtn::before, #undoBtn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.6s;
      clip-path: polygon(20% 0%, 80% 0%, 100% 50%, 80% 100%, 20% 100%, 0% 50%);
    }

    #helpBtn:hover::before, #loremBtn:hover::before, #undoBtn:hover::before {
      left: 100%;
    }

    /* Dormant button hover effect */
    button[style*="linear-gradient(135deg, #a55eea"]:hover {
      transform: translateY(-5px) scale(1.1) rotate(4deg);
      box-shadow: 0 15px 40px rgba(165, 94, 234, 0.6);
      background: linear-gradient(135deg, #b794f4, #a55eea) !important;
      animation: pulse 2s infinite;
    }

    button[style*="linear-gradient(135deg, #a55eea"]:active {
      transform: translateY(-3px) scale(0.95) rotate(-2deg);
    }

    .dormant {
      display: none !important;
    }

    .dormant-revealed {
      display: inline-block !important;
      outline: 2px dotted #e67e22 !important;
      background: #fffbe6 !important;
      color: #e67e22 !important;
      opacity: 0.8;
      cursor: pointer;
    }

    .editable-form-embed {
      width: 100% !important;
      height: 500px;
      display: block;
      border: none;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    .iframe-wrapper {
      position: relative;
      display: inline-block;
      overflow: hidden;
    }
    
    .iframe-overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: transparent;
      z-index: 1000;
      cursor: pointer;
    }

    /* Help popup specific z-index override */
    .edit-overlay.help-popup {
      z-index: 999999999 !important;
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
    }

    .edit-backdrop.help-backdrop {
      z-index: 999999998 !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
    }

    /* Version management popup specific z-index override */
    .edit-overlay.version-popup {
      z-index: 999999999 !important;
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      max-width: 800px !important;
      width: 90vw !important;
      max-height: 85vh !important;
      overflow-y: auto !important;
    }

    .edit-backdrop.version-backdrop {
      z-index: 999999998 !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
    }

    /* Enhanced popup animations and interactions */
    .edit-overlay {
      transition: all 0.2s ease-out;
    }

    .edit-overlay:hover {
      transform: translate(-50%, -50%) scale(1.02);
      box-shadow: 0 30px 100px rgba(0, 0, 0, 0.25);
    }

    /* Dynamic z-index management for popups */
    .edit-overlay {
      z-index: var(--popup-z-index, 2100);
    }

    .edit-backdrop {
      z-index: var(--backdrop-z-index, 2000);
    }

    /* Improved button interactions */
    .edit-overlay button {
      transition: all 0.2s ease-out;
    }

    .edit-overlay button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .edit-overlay button:active {
      transform: translateY(0);
    }

    /* Enhanced backdrop interaction */
    .edit-backdrop {
      backdrop-filter: blur(5px);
      transition: backdrop-filter 0.3s ease-out;
    }

    /* Loading states for buttons */
    .edit-overlay button.loading {
      position: relative;
      color: transparent;
    }

    .edit-overlay button.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 16px;
      height: 16px;
      margin: -8px 0 0 -8px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
  </style>
</head>

<body>
  <div id="editor">
    <iframe id="pageFrame"></iframe>
  </div>
  

  
  <button id="publishBtn" style="position: fixed; bottom: 20px; right: 20px; padding: 16px 20px; background: #000000; color: white; border: 2px solid #dc3545; cursor: pointer; z-index: 9999; font-weight: 700; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); width: 130px; height: 60px; backdrop-filter: blur(15px); animation: slideIn 0.6s ease-out 0.5s both; text-transform: uppercase; letter-spacing: 0.5px; overflow: hidden; clip-path: polygon(20% 0%, 80% 0%, 100% 50%, 80% 100%, 20% 100%, 0% 50%); transform: rotate(0deg);">🌐 PUBLISH TO WEB</button>
  <div id="statusBar" style="position: fixed; top: 10px; right: 10px; background: #000000; color: white; padding: 15px 20px; border-radius: 12px; font-size: 13px; z-index: 9999; display: none; backdrop-filter: blur(15px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); font-weight: 600; border: 2px solid #dc3545; animation: slideIn 0.4s ease-out;">Ready</div>
  <div id="commitStatus" class="commit-status">
    <div class="spinner"></div>
    <h3>Committing Changes...</h3>
    <p>Please wait 30-45 seconds to see changes on mainframe</p>
  </div>
  <button id="helpBtn" style="position: fixed; bottom: 340px; right: 20px; padding: 16px 20px; background: #000000; color: white; border: 2px solid #dc3545; cursor: pointer; z-index: 9999; font-weight: 700; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); width: 130px; height: 60px; backdrop-filter: blur(15px); animation: slideIn 0.6s ease-out 0.1s both; text-transform: uppercase; letter-spacing: 0.5px; overflow: hidden; clip-path: polygon(20% 0%, 80% 0%, 100% 50%, 80% 100%, 20% 100%, 0% 50%); transform: rotate(0deg);">⚙️ Settings</button>
  <button id="loremBtn" style="position: fixed; bottom: 260px; right: 20px; padding: 16px 20px; background: #000000; color: white; border: 2px solid #dc3545; cursor: pointer; z-index: 9999; font-weight: 700; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); width: 130px; height: 60px; backdrop-filter: blur(15px); animation: slideIn 0.6s ease-out 0.2s both; text-transform: uppercase; letter-spacing: 0.5px; overflow: hidden; clip-path: polygon(20% 0%, 80% 0%, 100% 50%, 80% 100%, 20% 100%, 0% 50%); transform: rotate(0deg);">📝 Lorem</button>
  <button id="undoBtn" style="position: fixed; bottom: 180px; right: 20px; padding: 16px 20px; background: #000000; color: white; border: 2px solid #dc3545; cursor: pointer; z-index: 9999; font-weight: 700; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); width: 130px; height: 60px; backdrop-filter: blur(15px); animation: slideIn 0.6s ease-out 0.3s both; text-transform: uppercase; letter-spacing: 0.5px; overflow: hidden; clip-path: polygon(20% 0%, 80% 0%, 100% 50%, 80% 100%, 20% 100%, 0% 50%); transform: rotate(0deg);">↶ Undo</button>
  
  <!-- New automation elements -->
  <div class="progress-bar"></div>
  <div class="shortcuts-hint" style="position: fixed; bottom: 20px; left: 20px; z-index: 100; background: #000000; color: white; padding: 8px 15px; font-size: 11px; backdrop-filter: blur(15px); box-shadow: 0 4px 15px rgba(0,0,0,0.4); font-weight: 700; border: 2px solid #dc3545; opacity: 1; border-radius: 8px; height: auto; display: flex; align-items: center; flex-wrap: wrap; max-width: 375px; text-transform: uppercase; letter-spacing: 0.5px;">
          <div style="margin-right: 15px;">⌨️ <strong>Ctrl+S:</strong> Save Work | <strong>Ctrl+Shift+S:</strong> Publish | <strong>Ctrl+Shift+V:</strong> Save Ver</div>
      <div style="margin-right: 15px;"><strong>Ctrl+R:</strong> Reload | <strong>Ctrl+Z:</strong> Undo | <strong>Ctrl+Shift+A:</strong> Quick Actions</div>
  </div>
  <div class="quick-actions" id="quickActions">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h3 style="margin: 0;">Quick Actions</h3>
      <button onclick="closeQuickActions();" style="background: #000000; border: 2px solid #dc3545; color: white; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">✕ Close</button>
    </div>
    <div id="actionsList"></div>
  </div>


  <script>
    const USERNAME = 'will292929';
    const REPO = 'test7';
    let FILE_PATH = 'index.html';
    const BRANCH = 'main';
    let TOKEN = localStorage.getItem('github_token') || prompt('Enter GitHub Token:');
    if (TOKEN) localStorage.setItem('github_token', TOKEN);
    
    // Validate token format
    if (TOKEN && !TOKEN.startsWith('ghp_') && !TOKEN.startsWith('github_pat_')) {
      alert('⚠️ Invalid token format. Please use a GitHub Personal Access Token.');
      TOKEN = prompt('Enter valid GitHub Token:');
      if (TOKEN) localStorage.setItem('github_token', TOKEN);
    }
    
    // Page selector functionality
    // ADD NEW PAGES HERE - just add a new line with the filename
    const AVAILABLE_PAGES = [
      'index.html',
      'about.html',
      'command.html',
      'customer.html',
      'elite.html',
      'launch.html',
      'sync-lite.html',
      'sync-performance.html'
    ];
    
    // Initialize enhanced page selector dropdown with custom dropdown
    function initializePageSelector() {
      const pageSelect = document.getElementById('pageSelect');
      const pageSelector = document.getElementById('pageSelector');
      
      // Ensure the page selector is visible with enhanced styling
      pageSelector.style.display = 'block';
      pageSelector.style.visibility = 'visible';
      pageSelector.style.opacity = '1';
      pageSelector.style.transform = 'translateY(0)';
      
      // Clear existing options
      pageSelect.innerHTML = '';
      
      // Add options for each available page with enhanced styling
      AVAILABLE_PAGES.forEach(page => {
        const option = document.createElement('option');
        option.value = page;
        option.textContent = page;
        option.style.padding = '8px 12px';
        option.style.fontWeight = '500';
        if (page === FILE_PATH) {
          option.selected = true;
        }
        pageSelect.appendChild(option);
      });
      
      // Ensure the select element is properly styled and visible
      pageSelect.style.display = 'block';
      pageSelector.style.visibility = 'visible';
      pageSelect.style.opacity = '1';
      pageSelect.style.zIndex = '10001';
      
      // Create custom dropdown overlay
      createCustomDropdown();
      
      // Add enhanced change event listener with visual feedback
      pageSelect.addEventListener('change', function() {
        const selectedPage = this.value;
        if (selectedPage !== FILE_PATH) {
          // Add visual feedback
          pageSelector.style.transform = 'translateY(-5px) scale(1.02)';
          pageSelector.style.boxShadow = '0 20px 60px rgba(0,0,0,0.7)';
          
          setTimeout(() => {
            pageSelector.style.transform = 'none';
            pageSelector.style.boxShadow = '0 12px 40px rgba(0,0,0,0.5)';
            switchPage(selectedPage);
          }, 200);
        }
      });
      
      // Add enhanced click event with focus effects
      pageSelect.addEventListener('click', function(e) {
        e.stopPropagation();
        this.focus();
        
        // Add click animation
        pageSelector.style.transform = 'scale(0.98)';
        setTimeout(() => {
          pageSelector.style.transform = 'none';
        }, 100);
      });
      
      // Add focus effects
      pageSelect.addEventListener('focus', function() {
        pageSelector.style.borderColor = 'rgba(255,255,255,0.5)';
        pageSelector.style.boxShadow = '0 15px 50px rgba(0,0,0,0.6)';
      });
      
      pageSelect.addEventListener('blur', function() {
        pageSelector.style.borderColor = 'rgba(255,255,255,0.2)';
        pageSelector.style.boxShadow = '0 12px 40px rgba(0,0,0,0.5)';
      });
      
      console.log('Enhanced page selector initialized with', AVAILABLE_PAGES.length, 'pages');
    }

    // Create custom dropdown overlay for better selection experience
    function createCustomDropdown() {
      const pageSelect = document.getElementById('pageSelect');
      const pageSelector = document.getElementById('pageSelector');
      
      // Hide the original select
      pageSelect.style.opacity = '0';
      pageSelect.style.position = 'absolute';
      pageSelect.style.pointerEvents = 'none';
      
      // Create custom dropdown trigger
      const customTrigger = document.createElement('div');
      customTrigger.className = 'custom-dropdown-trigger';
      customTrigger.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
          <span id="selectedPageText" style="color: white; font-weight: 600; transform: none; writing-mode: horizontal-tb; text-orientation: mixed; direction: ltr; display: inline-block;">${FILE_PATH}</span>
          <div style="font-size: 16px; color: white; transition: transform 0.3s ease;">▼</div>
        </div>
      `;
      customTrigger.style.cssText = `
        width: 100%;
        padding: 14px 16px;
        border-radius: 12px;
        border: 2px solid rgba(255,255,255,0.3);
        background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
        color: white;
        font-size: 14px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        outline: none;
        position: relative;
        z-index: 2;
        transform: none;
        margin: 0;
        box-sizing: border-box;
      `;
      
      // Replace the select with custom trigger
      const selectContainer = pageSelector.querySelector('div[style*="position: relative"]');
      selectContainer.innerHTML = '';
      selectContainer.style.padding = '0';
      selectContainer.style.margin = '0';
      selectContainer.appendChild(customTrigger);
      
      // Create custom dropdown menu
      const customDropdown = document.createElement('div');
      customDropdown.className = 'custom-dropdown-menu';
      customDropdown.style.cssText = `
        position: absolute;
        bottom: 100%;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, rgba(0,0,0,0.95), rgba(0,0,0,0.9));
        border-radius: 12px;
        margin-bottom: 8px;
        padding: 8px;
        box-shadow: 0 15px 50px rgba(0,0,0,0.8);
        backdrop-filter: blur(20px);
        border: 2px solid rgba(255,255,255,0.2);
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transform: translateY(10px);
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        max-height: 200px;
        overflow-y: auto;
      `;
      
      // Add options to custom dropdown
      AVAILABLE_PAGES.forEach(page => {
        const option = document.createElement('div');
        option.className = 'custom-dropdown-option';
        option.textContent = page;
        option.style.cssText = `
          padding: 12px 16px;
          margin: 2px 0;
          border-radius: 8px;
          color: white;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.2s ease;
          background: ${page === FILE_PATH ? 'linear-gradient(135deg, #007bff, #0056b3)' : 'transparent'};
          border: ${page === FILE_PATH ? '1px solid rgba(0, 123, 255, 0.5)' : '1px solid transparent'};
        `;
        
        option.addEventListener('click', () => {
          selectPage(page);
          hideCustomDropdown();
        });
        
        option.addEventListener('mouseenter', () => {
          if (page !== FILE_PATH) {
            option.style.background = 'linear-gradient(135deg, #3498db, #2980b9)';
            option.style.transform = 'translateX(5px)';
          }
        });
        
        option.addEventListener('mouseleave', () => {
          if (page !== FILE_PATH) {
            option.style.background = 'transparent';
            option.style.transform = 'translateX(0)';
          }
        });
        
        customDropdown.appendChild(option);
      });
      
      selectContainer.appendChild(customDropdown);
      
      // Show/hide dropdown on trigger click
      customTrigger.addEventListener('click', (e) => {
        e.stopPropagation();
        if (customDropdown.style.visibility === 'hidden') {
          showCustomDropdown();
        } else {
          hideCustomDropdown();
        }
      });
      
      // Smart positioning - check if dropdown fits above, otherwise show below
      function checkDropdownPosition() {
        const triggerRect = customTrigger.getBoundingClientRect();
        const dropdownHeight = 200; // max-height of dropdown
        const spaceAbove = triggerRect.top;
        const spaceBelow = window.innerHeight - triggerRect.bottom;
        
        if (spaceAbove < dropdownHeight && spaceBelow > dropdownHeight) {
          // Not enough space above, show below
          customDropdown.style.bottom = 'auto';
          customDropdown.style.top = '100%';
          customDropdown.style.marginBottom = '0';
          customDropdown.style.marginTop = '8px';
          customDropdown.style.transform = 'translateY(-10px)';
        } else {
          // Show above (default)
          customDropdown.style.top = 'auto';
          customDropdown.style.bottom = '100%';
          customDropdown.style.marginTop = '0';
          customDropdown.style.marginBottom = '8px';
          customDropdown.style.transform = 'translateY(10px)';
        }
      }
      
      // Hide dropdown when clicking outside
      document.addEventListener('click', () => {
        hideCustomDropdown();
      });
      
      function showCustomDropdown() {
        checkDropdownPosition();
        customDropdown.style.opacity = '1';
        customDropdown.style.visibility = 'visible';
        customDropdown.style.transform = 'translateY(0)';
        customTrigger.querySelector('div').style.transform = 'rotate(180deg)';
      }
      
      function hideCustomDropdown() {
        customDropdown.style.opacity = '0';
        customDropdown.style.visibility = 'hidden';
        // Reset to default position (above)
        customDropdown.style.bottom = '100%';
        customDropdown.style.top = 'auto';
        customDropdown.style.marginBottom = '8px';
        customDropdown.style.marginTop = '0';
        customDropdown.style.transform = 'translateY(10px)';
        customTrigger.querySelector('div').style.transform = 'rotate(0deg)';
      }
      
      function selectPage(page) {
        const selectedText = document.getElementById('selectedPageText');
        selectedText.textContent = page;
        selectedText.style.transform = 'none';
        pageSelect.value = page;
        pageSelect.dispatchEvent(new Event('change'));
      }
    }
    
    // Function to switch pages
    async function switchPage(newPage) {
      try {
        console.log('switchPage called with:', newPage);
        showStatus(`🔄 Switching to ${newPage}...`, 2000, 'info');
        
        // Save current state if needed
        const doc = frame.contentDocument || frame.contentWindow.document;
        if (doc && doc.documentElement) {
          // You could save the current page state here if needed
        }
        
        // Update FILE_PATH and load new page
        console.log('Updating FILE_PATH from', FILE_PATH, 'to', newPage);
        FILE_PATH = newPage;
        console.log('Loading HTML for new page...');
        await loadHTML();
        
        // Reset history for new page
        console.log('Initializing history for new page...');
        initializeHistory();
        
        console.log('Page switch completed successfully');
        showStatus(`✅ Switched to ${newPage}`, 2000, 'success');
        
      } catch (error) {
        console.error('Failed to switch page:', error);
        showStatus(`❌ Failed to load ${newPage}`, 3000, 'error');
      }
    }
    
    // History for undo functionality
    let history = [];
    let historyIndex = -1;
    const MAX_HISTORY = 20;
    let isUndoing = false; // Flag to prevent conflicts during undo
    
    // Initialize history when frame loads
    function initializeHistory() {
      console.log('🔄 Attempting to initialize history...');
      const doc = frame.contentDocument || frame.contentWindow.document;
      console.log('Document available:', !!doc);
      console.log('Document element available:', !!(doc && doc.documentElement));
      
      if (doc && doc.documentElement) {
        const html = doc.documentElement.outerHTML;
        history = [html];
        historyIndex = 0;
        const undoBtn = document.getElementById('undoBtn');
        undoBtn.disabled = true;
        console.log('🚀 History initialized. Index:', historyIndex, 'History length:', history.length, 'HTML length:', html.length);
      } else {
        console.log('❌ Could not initialize history - no document available');
        console.log('Frame src:', frame.src);
        console.log('Frame srcdoc:', frame.srcdoc ? 'has content' : 'no content');
      }
    }
    
    // Enhanced status bar functionality
    function showStatus(message, duration = 3000, type = 'info') {
      const statusBar = document.getElementById('statusBar');
      
      // Add icon based on type
      const icons = {
        'info': 'ℹ️',
        'success': '✅',
        'warning': '⚠️',
        'error': '❌'
      };
      
      statusBar.innerHTML = `${icons[type] || 'ℹ️'} ${message}`;
      statusBar.style.display = 'block';
      
      // Add type-based styling
      statusBar.className = `status-${type}`;
      
      // Add entrance animation
      statusBar.style.transform = 'translateY(-20px)';
      statusBar.style.opacity = '0';
      
      setTimeout(() => {
        statusBar.style.transform = 'translateY(0)';
        statusBar.style.opacity = '1';
      }, 10);
      
      if (duration > 0) {
        setTimeout(() => {
          statusBar.style.transform = 'translateY(-20px)';
          statusBar.style.opacity = '0';
          setTimeout(() => {
            statusBar.style.display = 'none';
          }, 300);
        }, duration);
      }
    }

    // Enhanced error handling
    function handleError(error, context = '') {
      console.error(`Error in ${context}:`, error);
      showStatus(`❌ ${context}: ${error.message}`, 5000, 'error');
    }

    // Enhanced success feedback
    function showSuccess(message, duration = 3000) {
      showStatus(message, duration, 'success');
      
      // Add subtle success animation
      const buttons = document.querySelectorAll('button');
      buttons.forEach(btn => {
        if (btn.textContent.includes('Save') || btn.textContent.includes('Publish')) {
          btn.style.transform = 'scale(1.05)';
          btn.style.boxShadow = '0 8px 25px rgba(40, 167, 69, 0.4)';
          setTimeout(() => {
            btn.style.transform = '';
            btn.style.boxShadow = '';
          }, 300);
        }
      });
    }

    // Enhanced auto-save functionality
    let autoSaveInterval;
    let lastSavedState = '';
    let hasUnsavedChanges = false;
    
    function startAutoSave() {
      autoSaveInterval = setInterval(() => {
        const doc = frame.contentDocument || frame.contentWindow.document;
        if (!doc || !doc.documentElement) return;
        
        const currentState = doc.documentElement.outerHTML;
        
        if (currentState !== lastSavedState) {
          hasUnsavedChanges = true;
          updateSaveButtonState();
          
          // Show subtle indicator
          const saveBtn = document.getElementById('saveWorkBtn');
          if (saveBtn) {
            saveBtn.style.animation = 'pulse 2s infinite';
          }
        }
      }, 10000); // Check every 10 seconds
    }

    function stopAutoSave() {
      if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
      }
    }

    function updateSaveButtonState() {
      const publishBtn = document.getElementById('publishBtn');
      
      // Check if publish button exists before trying to access its properties
      if (!publishBtn) {
        return; // Exit early if button doesn't exist yet
      }
      
      if (hasUnsavedChanges) {
        // Add subtle warning to publish button
        publishBtn.style.opacity = '0.8';
        publishBtn.title = 'You have unsaved changes. Save first for best results.';
      } else {
        publishBtn.style.opacity = '1';
        publishBtn.title = 'Publish changes to live website';
      }
    }

    function markAsSaved() {
      hasUnsavedChanges = false;
      updateSaveButtonState();
    }

    // Smart element detection
    function detectElementType(el) {
      const tag = el.tagName.toLowerCase();
      const text = el.innerText?.trim();
      const hasText = !!text;
      const hasImage = el.querySelector('img') || tag === 'img';
      const hasLink = el.querySelector('a') || tag === 'a';
      
      return {
        type: hasImage ? 'image' : hasLink ? 'link' : hasText ? 'text' : 'container',
        tag: tag,
        hasText: hasText,
        hasImage: hasImage,
        hasLink: hasLink
      };
    }

    // Smart suggestions
    function getSmartSuggestions(el) {
      const detection = detectElementType(el);
      const suggestions = [];
      
      switch (detection.type) {
        case 'image':
          suggestions.push('browse', 'style', 'copy', 'delete');
          break;
        case 'link':
          suggestions.push('url', 'text', 'style', 'copy', 'delete');
          break;
        case 'text':
          suggestions.push('text', 'style', 'copy', 'delete');
          break;
        default:
          suggestions.push('text', 'style', 'googleform', 'youtube', 'copy', 'delete');
      }
      
      return suggestions;
    }


    const frame = document.getElementById('pageFrame');
    let spaceHeld = false, spaceJustUsed = false, sha = '';
    
    // Dynamic z-index management for popups
    let popupCounter = 2100;
    let backdropCounter = 2000;
    
    function getNextPopupZIndex() {
      popupCounter += 10;
      resetZIndexCounters();
      return popupCounter;
    }
    
    function getNextBackdropZIndex() {
      backdropCounter += 10;
      resetZIndexCounters();
      return backdropCounter;
    }
    
    // Universal function to close any popup
    function closePopup() {
      console.log('closePopup() called');
      // Remove all popups and backdrops
      const elements = document.querySelectorAll('.edit-overlay, .edit-backdrop, .quick-actions-backdrop');
      console.log('Found elements to remove:', elements.length);
      elements.forEach(el => {
        if (el && el.parentNode) {
          console.log('Removing element:', el.className);
          el.remove();
        }
      });
      console.log('closePopup() completed');
    }
    
    function createPopupWithZIndex() {
      const overlay = document.createElement('div');
      const backdrop = document.createElement('div');
      
      const popupZ = getNextPopupZIndex();
      const backdropZ = getNextBackdropZIndex();
      
      overlay.className = 'edit-overlay';
      backdrop.className = 'edit-backdrop';
      
      overlay.style.setProperty('--popup-z-index', popupZ);
      backdrop.style.setProperty('--backdrop-z-index', backdropZ);
      
      return { overlay, backdrop };
    }
    
    // Reset z-index counters if they get too high
    function resetZIndexCounters() {
      if (popupCounter > 10000) {
        popupCounter = 2100;
        backdropCounter = 2000;
        console.log('🔄 Reset z-index counters');
      }
    }

    // Debug function to check for z-index conflicts
    function debugZIndexConflicts() {
      console.log('🔍 Checking for z-index conflicts...');
      
      // Check all elements with high z-index values
      const highZIndexElements = document.querySelectorAll('[style*="z-index"]');
      console.log('Found elements with z-index:', highZIndexElements.length);
      
      highZIndexElements.forEach((el, index) => {
        const zIndex = window.getComputedStyle(el).zIndex;
        if (parseInt(zIndex) > 1000) {
          console.log(`Element ${index}:`, {
            tagName: el.tagName,
            className: el.className,
            zIndex: zIndex,
            visible: el.offsetParent !== null,
            display: window.getComputedStyle(el).display,
            position: window.getComputedStyle(el).position
          });
        }
      });
      
      // Check for any hidden overlays
      const hiddenOverlays = document.querySelectorAll('.edit-overlay, .edit-backdrop');
      console.log('Hidden overlays found:', hiddenOverlays.length);
      hiddenOverlays.forEach((el, index) => {
        console.log(`Overlay ${index}:`, {
          className: el.className,
          zIndex: window.getComputedStyle(el).zIndex,
          visible: el.offsetParent !== null,
          display: window.getComputedStyle(el).display,
          position: window.getComputedStyle(el).position
        });
      });
    }


    // Enhanced keyboard shortcuts
    window.addEventListener('keydown', e => {
      if (e.code === 'Space' && !spaceHeld) {
        spaceHeld = true;
        spaceJustUsed = false;
      }
      
      // Ctrl+S to save work locally
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        // Create save work popup directly
        const { overlay, backdrop } = createPopupWithZIndex();
        overlay.innerHTML = `
          <h3>💾 Save Work</h3>
          <p>Enter a label for this saved work:</p>
          <input type="text" id="saveWorkLabel" placeholder="e.g., Homepage v1, Contact form, etc." style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid rgba(255,255,255,0.4); background: rgba(255,255,255,0.95); color: #333; font-size: 14px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <div class="button-group" style="display: flex; gap: 10px;">
            <button onclick="saveWorkWithLabel();" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">💾 Save</button>
            <button onclick="closePopup();" style="flex: 1; padding: 10px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 8px; cursor: pointer;">Cancel</button>
          </div>
        `;
        document.body.append(backdrop, overlay);
        setTimeout(() => {
          const labelInput = document.getElementById('saveWorkLabel');
          if (labelInput) labelInput.focus();
        }, 100);
        backdrop.onclick = () => closePopup();
        showStatus('💾 Save work popup opened!', 2000, 'info');
      }
      
      // Ctrl+Shift+S to publish to web
      if (e.ctrlKey && e.shiftKey && e.key === 'S') {
        e.preventDefault();
        if (confirm('⚠️ This will publish your changes to the live website. Continue?')) {
          const publishBtn = document.getElementById('publishBtn');
          if (publishBtn) {
            publishBtn.click();
            showStatus('🌐 Publishing to web...', 2000, 'info');
          } else {
            showStatus('❌ Publish button not found', 2000, 'error');
          }
        }
      }
      
            // Ctrl+Shift+V to save version
      if (e.ctrlKey && e.shiftKey && e.key === 'V') {
        e.preventDefault();
        showSaveVersionPopup();
        showStatus('📁 Opening save version dialog...', 2000, 'info');
      }
      
      // Ctrl+Shift+L to view versions
      if (e.ctrlKey && e.shiftKey && e.key === 'L') {
        e.preventDefault();
        showViewVersionsPopup();
        showStatus('👁️ Opening view versions dialog...', 2000, 'info');
      }
      
      // Ctrl+R to reload
      if (e.ctrlKey && e.key === 'r') {
        e.preventDefault();
        loadHTML();
        showStatus('🔄 Page reloaded!', 2000, 'info');
      }
      
      // Ctrl+Z to undo
      if (e.ctrlKey && e.key === 'z') {
        e.preventDefault();
        const undoBtn = document.getElementById('undoBtn');
        if (undoBtn && !undoBtn.disabled) {
          undoBtn.click();
          showStatus('↶ Undone!', 2000, 'info');
        } else {
          showStatus('❌ Nothing to undo', 2000, 'warning');
        }
      }

      // Ctrl+Shift+A for quick actions
      if (e.ctrlKey && e.shiftKey && e.key === 'A') {
        e.preventDefault();
        showQuickActions();
      }

      // Ctrl+H for help
      if (e.ctrlKey && e.key === 'h') {
        e.preventDefault();
        showHelp();
      }

      // Ctrl+L for lorem ipsum
      if (e.ctrlKey && e.key === 'l') {
        e.preventDefault();
        document.getElementById('loremBtn').click();
      }

      // Escape to close modals
      if (e.key === 'Escape') {
        const modals = document.querySelectorAll('.edit-overlay');
        const quickActions = document.getElementById('quickActions');
        
        if (modals.length > 0) {
          modals.forEach(el => el.remove());
          document.querySelectorAll('.edit-backdrop').forEach(el => el.remove());
          showStatus('🚪 Modal closed', 1000, 'info');
        }
        
        if (quickActions && quickActions.style.display === 'block') {
          closeQuickActions();
        }
        
        // Also check for any stuck quick actions backdrops
        const stuckBackdrops = document.querySelectorAll('.quick-actions-backdrop');
        if (stuckBackdrops.length > 0) {
          stuckBackdrops.forEach(el => el.remove());
          if (quickActions) {
            quickActions.style.display = 'none';
          }
          showStatus('🚪 Quick actions force closed', 1000, 'info');
        }
      }

    });

    // F1 for settings
    window.addEventListener('keydown', e => {
      if (e.key === 'F1') {
        e.preventDefault();
        document.getElementById('helpBtn').click();
      }
    });

    window.addEventListener('keyup', e => {
      if (e.code === 'Space') {
        spaceHeld = false;
        spaceJustUsed = false;
      }
    });

    // Quick actions functions
    function showQuickActions() {
      // Remove any existing backdrops
      document.querySelectorAll('.quick-actions-backdrop').forEach(el => el.remove());
      
      // Create backdrop with dynamic z-index
      const backdrop = document.createElement('div');
      backdrop.className = 'quick-actions-backdrop';
      const backdropZ = getNextBackdropZIndex();
      backdrop.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.3);
        z-index: ${backdropZ};
        cursor: pointer;
      `;
      
      // Close on backdrop click
      backdrop.onclick = (e) => {
        e.stopPropagation();
        closeQuickActions();
      };
      
      const actionsList = document.getElementById('actionsList');
      actionsList.innerHTML = '';
      
      const actions = [
        { icon: '💾', text: 'Save Work (Local)', action: () => {
          // Create popup for custom label with dynamic z-index
          const { overlay, backdrop } = createPopupWithZIndex();
          overlay.innerHTML = `
            <h3>💾 Save Work</h3>
            <p>Enter a label for this saved work:</p>
            <input type="text" id="saveWorkLabel" placeholder="e.g., Homepage v1, Contact form, etc." style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #dc3545; background: #000000; color: #ffffff; font-size: 14px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(220,53,69,0.2);">
            <div class="button-group" style="display: flex; gap: 10px;">
              <button onclick="saveWorkWithLabel();" style="flex: 1; padding: 10px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">💾 Save</button>
              <button onclick="closePopup();" style="flex: 1; padding: 10px; background: #000000; border: 2px solid #dc3545; color: white; border-radius: 8px; cursor: pointer; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Cancel</button>
            </div>
          `;
          document.body.append(backdrop, overlay);
          
          // Focus the input
          setTimeout(() => {
            const labelInput = document.getElementById('saveWorkLabel');
            if (labelInput) {
              labelInput.focus();
            }
          }, 100);
          
          // Add backdrop click to close
          backdrop.onclick = () => closePopup();
          
          // Add Enter key support
          document.addEventListener('keydown', function enterHandler(e) {
            if (e.key === 'Enter') {
              saveWorkWithLabel();
              document.removeEventListener('keydown', enterHandler);
            }
          });
          
          showStatus('💾 Save work popup opened!', 2000, 'info');
        }},
        { icon: '🌐', text: 'PUBLISH TO WEB', action: () => {
          if (confirm('⚠️ This will publish your changes to the live website. Are you sure you want to commit to the main files?')) {
            document.getElementById('publishBtn').click();
          }
        }},
        { icon: '🔄', text: 'Reload Page', action: () => loadHTML() },
        { icon: '↶', text: 'Undo Last Change', action: () => {
          console.log('🔄 Quick actions undo triggered');
          console.log('Current state:', { historyIndex, historyLength: history.length });
          
          if (historyIndex > 0) {
            historyIndex--;
            console.log('📋 Restoring to history index:', historyIndex);
            
            try {
              const htmlToRestore = history[historyIndex];
              if (!htmlToRestore) {
                throw new Error('No HTML content in history at index ' + historyIndex);
              }
              
              // Get current scroll position
              const currentDoc = frame.contentDocument || frame.contentWindow.document;
              const currentScrollTop = currentDoc ? currentDoc.documentElement.scrollTop || currentDoc.body.scrollTop : 0;
              const currentScrollLeft = currentDoc ? currentDoc.documentElement.scrollLeft || currentDoc.body.scrollLeft : 0;
              
              // Apply to main frame
              frame.srcdoc = htmlToRestore;
              
              // Wait for the main frame to load
              frame.onload = () => {
                const doc = frame.contentDocument || frame.contentWindow.document;
                if (doc) {
                  // Restore scroll position
                  doc.documentElement.scrollTop = currentScrollTop;
                  doc.documentElement.scrollLeft = currentScrollLeft;
                  doc.body.scrollTop = currentScrollTop;
                  doc.body.scrollLeft = currentScrollLeft;
                  
                  // Reattach handlers
                  attachAllHandlers(doc);
                  showDormantElements(dormantVisible);
                  
                  // Update undo button state
                  const undoBtn = document.getElementById('undoBtn');
                  if (undoBtn) {
                    undoBtn.disabled = historyIndex <= 0;
                  }
                  
                  console.log('✅ Quick actions undo completed successfully');
                  showStatus('↶ Undone!', 2000, 'info');
                }
              };
            } catch (error) {
              console.error('❌ Error during quick actions undo:', error);
              showStatus('❌ Undo failed: ' + error.message, 3000, 'error');
            }
          } else {
            console.log('❌ Nothing to undo - history index is 0');
            showStatus('❌ Nothing to undo', 2000, 'warning');
          }
        }},
        { icon: '👁️', text: 'Toggle Dormant Elements', action: () => {
          // Find the main dormant button by looking for the specific text content
          const allButtons = document.querySelectorAll('button');
          const dormantBtn = Array.from(allButtons).find(btn => 
            btn.textContent.includes('Show Dormant') || btn.textContent.includes('Hide Dormant')
          );
          
          if (dormantBtn) {
            // Simply click the main dormant button - this is the safest approach
            dormantBtn.click();
            showStatus('👁️ Dormant toggle activated!', 2000, 'info');
          } else {
            showStatus('⚠️ Dormant button not found', 2000, 'warning');
          }
        }},
        { icon: '📋', text: 'Copy Page URL', action: () => copyPageUrl() },
        { icon: '🎨', text: 'Toggle Dark Mode', action: () => {
          toggleDarkMode();
          showStatus('🎨 Dark mode toggled!', 2000, 'info');
        }},
        { icon: '📊', text: 'Page Statistics', action: () => showPageStats() },
        { icon: '📂', text: 'Load Saved Work', action: () => loadSavedWork() },
        { icon: '🔄', text: 'Reload & Reset', action: () => {
          if (confirm('This will reload the page and reset all changes. Continue?')) {
            loadHTML();
            history = [];
            historyIndex = -1;
            document.getElementById('undoBtn').disabled = true;
            showStatus('🔄 Page reloaded and history reset!', 3000, 'info');
          }
        }},
        { icon: '❓', text: 'Show Help', action: () => showHelp() }
      ];
      
      actions.forEach(action => {
        const item = document.createElement('div');
        item.className = 'action-item';
        item.innerHTML = `
          <span class="icon">${action.icon}</span>
          <span>${action.text}</span>
        `;
        item.onclick = (e) => {
          e.stopPropagation(); // Prevent event bubbling
          action.action();
          // Don't close immediately - let user click outside to close
        };
        actionsList.appendChild(item);
      });
      
      // Prevent clicks inside the popup from closing it
      document.getElementById('quickActions').onclick = (e) => {
        e.stopPropagation();
      };
      
      // Set dynamic z-index for quick actions
      const quickActionsZ = getNextPopupZIndex();
      document.getElementById('quickActions').style.zIndex = quickActionsZ;
      document.getElementById('quickActions').style.display = 'block';
      document.body.appendChild(backdrop);
      
      // Add a global click handler to help close stuck quick actions
      const globalClickHandler = (e) => {
        const quickActions = document.getElementById('quickActions');
        const backdrop = document.querySelector('.quick-actions-backdrop');
        
        // If quick actions is visible but backdrop is missing, close it
        if (quickActions && quickActions.style.display === 'block' && !backdrop) {
          quickActions.style.display = 'none';
          document.removeEventListener('click', globalClickHandler);
        }
      };
      
      // Add the handler after a short delay to avoid immediate triggering
      setTimeout(() => {
        document.addEventListener('click', globalClickHandler);
      }, 100);
    }

    function closeQuickActions() {
      const quickActions = document.getElementById('quickActions');
      const backdrop = document.querySelector('.quick-actions-backdrop');
      
      if (quickActions) {
        quickActions.style.display = 'none';
      }
      
      if (backdrop) {
        backdrop.remove();
      }
      
      // Also remove any other quick actions backdrops that might be stuck
      document.querySelectorAll('.quick-actions-backdrop').forEach(el => el.remove());
      
      showStatus('🚪 Quick actions closed', 1000, 'info');
    }

    function copyPageUrl() {
      const url = `https://${USERNAME}.github.io/${REPO}/${FILE_PATH}`;
      
      // Try modern clipboard API first
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url).then(() => {
          showStatus('📋 URL copied to clipboard!', 2000, 'success');
        }).catch((error) => {
          console.log('Clipboard API failed:', error);
          // Fallback to old method
          fallbackCopyTextToClipboard(url);
        });
      } else {
        // Fallback for older browsers
        fallbackCopyTextToClipboard(url);
      }
    }
    
    function showHelp() {
      // Remove any existing popups
      document.querySelectorAll('.edit-backdrop, .edit-overlay').forEach(x => x.remove());

      const { overlay: overlayBox, backdrop } = createPopupWithZIndex();
      overlayBox.className = 'edit-overlay help-popup';
      overlayBox.style.position = 'fixed !important';
      overlayBox.style.top = '50% !important';
      overlayBox.style.left = '50% !important';
      overlayBox.style.transform = 'translate(-50%, -50%) !important';
      overlayBox.style.animation = 'none !important';
      overlayBox.style.transition = 'none !important';
      
      backdrop.className = 'edit-backdrop help-backdrop';
      backdrop.style.position = 'fixed !important';
      backdrop.style.top = '0 !important';
      backdrop.style.left = '0 !important';
      backdrop.style.width = '100vw !important';
      backdrop.style.height = '100vh !important';

      overlayBox.innerHTML = `
        <div style="z-index: 999999999 !important; position: relative !important; display: block !important;">
          <h3 style="z-index: 999999999 !important; position: relative !important; color: #ffffff; font-size: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">🎯 Visual GitHub Pages Editor Help</h3>
          <div style="max-height: 500px; overflow-y: auto; padding: 20px; background: #000000; border-radius: 8px; margin: 15px 0; color: #ffffff; z-index: 999999999 !important; position: relative !important; display: block !important; border: 2px solid #dc3545;">
            <h4 style="color: #ffffff; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">📝 How to use:</h4>
            <ul style="color: #ffffff;">
              <li>Click any element to edit it</li>
              <li>Hold SPACEBAR + click to follow links</li>
              <li>Use Ctrl+S to save work locally</li>
              <li>Use Ctrl+R to reload the page</li>
              <li>Use Ctrl+Z to undo changes</li>
              <li>Use Ctrl+Shift+A for quick actions</li>
              <li>Use Escape to close modals</li>
            </ul>

            <h4 style="color: #ffffff; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Edit options:</h4>
            <ul style="color: #ffffff;">
              <li>URL: Change links and image sources</li>
              <li>Text: Edit text content</li>
              <li>Browse & Upload: Upload new images</li>
              <li>Styling: Change colors and fonts</li>
              <li>Embed Google Form: Add form embeds</li>
              <li>Embed YouTube Video: Add video embeds</li>
              <li>Copy Element: Duplicate any element</li>
              <li>Delete Element: Remove elements</li>
              <li>Remove Form: Remove embedded forms</li>
            </ul>

            <h4 style="color: #ffffff; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">💾 Save System:</h4>
            <ul style="color: #ffffff;">
              <li>💾 Save Work: Save changes locally with custom labels</li>
              <li>🌐 Publish to Web: Commit changes to GitHub repository</li>
              <li>Auto-restore: Reload page to restore saved work</li>
              <li>Multiple saves: Keep multiple versions with labels</li>
            </ul>

            <h4 style="color: #ffffff; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">↶ Undo System:</h4>
            <ul style="color: #ffffff;">
              <li>Ctrl+Z or Undo button to restore changes</li>
              <li>Works for all edits: text, images, deletions, styling</li>
              <li>Smooth transitions with scroll position preserved</li>
              <li>Multiple undo levels (up to 50 changes)</li>
            </ul>

            <h4 style="color: #ffffff; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">📄 Page Management:</h4>
            <ul style="color: #ffffff;">
              <li>Page selector dropdown to switch between HTML files</li>
              <li>Add new pages to AVAILABLE_PAGES array</li>
              <li>Automatic page switching with history preservation</li>
            </ul>

            <h4 style="color: #ffffff; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">👁️ Dormant elements:</h4>
            <ul style="color: #ffffff;">
              <li>Click "Show Dormant" to see hidden elements</li>
              <li>Hidden elements are marked with orange outline</li>
              <li>Click "Restore" to bring them back</li>
              <li>"Clean Up Page" removes all dormant elements</li>
            </ul>

            <h4 style="color: #ffffff; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">📝 Lorem Ipsum:</h4>
            <ul style="color: #ffffff;">
              <li>Click "Lorem" button for sample content</li>
              <li>Includes sample links for testing</li>
              <li>Perfect for placeholder content</li>
            </ul>

            <h4 style="color: #ffffff; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">🎬 Supported embeds:</h4>
            <ul style="color: #ffffff;">
              <li>Google Forms (any form URL)</li>
              <li>YouTube videos (any YouTube URL)</li>
              <li>Iframe editing with custom dimensions</li>
            </ul>

            <h4 style="color: #ffffff; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">🔧 Quick Actions (Ctrl+Shift+A):</h4>
            <ul style="color: #ffffff;">
              <li>Load Saved Work: Restore previous saves</li>
              <li>Copy Page URL: Copy current page URL</li>
              <li>Toggle Dark Mode: Switch theme</li>
              <li>Show Page Stats: View element counts</li>
              <li>Clean Up Page: Remove dormant elements</li>
            </ul>

            <h4 style="color: #ffffff; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">💾 Committing:</h4>
            <ul style="color: #ffffff;">
              <li>Changes are saved to your GitHub repository</li>
              <li>Images are uploaded to /images/ folder</li>
              <li>Dormant elements are hidden in the final page</li>
              <li>Progress indicators show commit status</li>
            </ul>

            <h4 style="color: #ffffff; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">🎨 UI Features:</h4>
            <ul style="color: #ffffff;">
              <li>Hexagonal buttons with proper spacing</li>
              <li>Smooth animations and transitions</li>
              <li>Status messages with icons</li>
              <li>Responsive design with backdrop blur</li>
              <li>Fixed positioning for all controls</li>
            </ul>
          </div>
          <div class="button-group" style="z-index: 999999999 !important; position: relative !important; display: block !important;">
            <button id="closeHelp" class="primary" style="z-index: 999999999 !important; position: relative !important;">Close</button>
          </div>
        </div>
      `;

      document.body.append(backdrop, overlayBox);

      backdrop.onclick = () => {
        overlayBox.remove();
        backdrop.remove();
      };

      document.getElementById('closeHelp').onclick = () => {
        overlayBox.remove();
        backdrop.remove();
      };

      // Force the element to be on top after creation
      setTimeout(() => {
        overlayBox.style.zIndex = '999999999 !important';
        overlayBox.style.position = 'fixed !important';
        overlayBox.style.top = '50% !important';
        overlayBox.style.left = '50% !important';
        overlayBox.style.transform = 'translate(-50%, -50%) !important';
      }, 0);
    }

    function fallbackCopyTextToClipboard(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      textArea.style.top = '-999999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          showStatus('📋 URL copied to clipboard!', 2000, 'success');
        } else {
          showStatus('❌ Failed to copy URL', 2000, 'error');
        }
      } catch (err) {
        showStatus('❌ Failed to copy URL', 2000, 'error');
      }
      
      document.body.removeChild(textArea);
    }
    
    // FIXED: Added z-index handling for load saved work popup to ensure it appears above all other elements
    function loadSavedWork() {
      console.log('🔄 loadSavedWork called');
      
      // Debug z-index conflicts before creating popup
      debugZIndexConflicts();
      
      const savedWork = [];
      
      // Find all saved work for current file
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('temp_work_') && key.includes(FILE_PATH)) {
          try {
            const data = JSON.parse(localStorage.getItem(key));
            savedWork.push({
              key: key,
              ...data
            });
          } catch (e) {
            console.error('Error parsing saved work:', e);
          }
        }
      }
      
      if (savedWork.length === 0) {
        showStatus('📂 No saved work found for this page', 3000, 'info');
        return;
      }
      
      // Sort by timestamp (newest first)
      savedWork.sort((a, b) => b.timestamp - a.timestamp);
      
      // Show selection dialog with dynamic z-index
      const { overlay, backdrop } = createPopupWithZIndex();
      
      // Add version-specific classes for proper z-index handling
      overlay.className = 'edit-overlay version-popup';
      backdrop.className = 'edit-backdrop version-backdrop';
      
      console.log('📋 Load saved work popup created with classes:', overlay.className, backdrop.className);
      
      // Make the popup larger and ensure it's visible
      overlay.style.maxWidth = '800px';
      overlay.style.width = '90vw';
      overlay.style.maxHeight = '70vh';
      overlay.style.overflow = 'auto';
      overlay.style.position = 'fixed';
      overlay.style.top = '50%';
      overlay.style.left = '50%';
      overlay.style.transform = 'translate(-50%, -50%)';
      overlay.style.zIndex = '999999999 !important';
      
      overlay.innerHTML = `
        <h3>📂 Load Saved Work</h3>
        <div style="max-height: 400px; overflow-y: auto; margin: 15px 0; padding-right: 10px;">
          ${savedWork.map((work, index) => `
            <div style="padding: 12px; margin: 8px 0; border: 2px solid #dc3545; border-radius: 8px; background: #000000; position: relative; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(220,53,69,0.2);">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1; cursor: pointer; padding: 5px;" onclick="loadSpecificWork('${work.key}')">
                  <strong style="color: #ffffff; font-size: 14px;">${work.description}</strong><br>
                                      <small style="color: #ffffff; font-size: 12px;">Saved: ${new Date(work.timestamp).toLocaleString()}</small>
                </div>
                <button onclick="deleteSavedWork('${work.key}'); event.stopPropagation();" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 6px 10px; font-size: 12px; cursor: pointer; transition: all 0.3s ease;">🗑️ Delete</button>
              </div>
            </div>
          `).join('')}
        </div>
        <div class="button-group" style="display: flex; gap: 10px; margin-top: 15px;">
          <button onclick="closePopup();" style="flex: 1; padding: 10px; background: #6c757d; border: 1px solid #6c757d; color: white; border-radius: 8px; cursor: pointer; font-weight: 500;">Cancel</button>
        </div>
      `;
      
      document.body.append(backdrop, overlay);
      
      // Force the popup to be on top
      setTimeout(() => {
        overlay.style.zIndex = '999999999 !important';
        backdrop.style.zIndex = '999999998 !important';
        overlay.style.position = 'fixed !important';
        overlay.style.top = '50% !important';
        overlay.style.left = '50% !important';
        overlay.style.transform = 'translate(-50%, -50%) !important';
        console.log('📋 Load saved work popup positioned and should be visible');
      }, 10);
      
      backdrop.onclick = () => {
        overlay.remove();
        backdrop.remove();
      };
    }
    
    function loadSpecificWork(key) {
      try {
        const data = JSON.parse(localStorage.getItem(key));
        if (data && data.html) {
          let htmlWithAttr = prepareIframeHTML(data.html);
          frame.srcdoc = htmlWithAttr;
          frame.onload = () => {
            const doc = frame.contentDocument || frame.contentWindow.document;
            attachAllHandlers(doc);
            showStatus('📂 Loaded saved work!', 3000, 'success');
          };
          
          // Close the dialog
          closePopup();
        }
      } catch (error) {
        console.error('Error loading saved work:', error);
        showStatus('❌ Failed to load saved work', 3000, 'error');
      }
    }

    function deleteSavedWork(key) {
      if (confirm('Are you sure you want to delete this saved work?')) {
        try {
          localStorage.removeItem(key);
          showStatus('🗑️ Saved work deleted!', 2000, 'info');
          
          // Refresh the load saved work dialog
          setTimeout(() => {
            loadSavedWork();
          }, 100);
        } catch (error) {
          console.error('Error deleting saved work:', error);
          showStatus('❌ Failed to delete saved work', 3000, 'error');
        }
      }
    }

    function toggleDarkMode() {
      const body = document.body;
      body.classList.toggle('dark-mode');
      const isDark = body.classList.contains('dark-mode');
      showStatus(`🌙 ${isDark ? 'Dark' : 'Light'} mode ${isDark ? 'enabled' : 'disabled'}!`, 2000, 'info');
    }

    function showPageStats() {
      const doc = frame.contentDocument || frame.contentWindow.document;
      const images = doc.querySelectorAll('img').length;
      const links = doc.querySelectorAll('a').length;
      const textElements = doc.querySelectorAll('p, h1, h2, h3, h4, h5, h6, span').length;
      const forms = doc.querySelectorAll('form, iframe').length;
      
      alert(`📊 Page Statistics:
      
🖼️ Images: ${images}
🔗 Links: ${links}
📝 Text Elements: ${textElements}
📋 Forms/Embeds: ${forms}
📄 Total Elements: ${images + links + textElements + forms}`);
    }

    function cleanUpPage() {
      const doc = frame.contentDocument || frame.contentWindow.document;
      const dormantElements = doc.querySelectorAll('.dormant');
      
      if (dormantElements.length > 0) {
        if (confirm(`🧹 Clean up ${dormantElements.length} dormant elements?`)) {
          dormantElements.forEach(el => el.remove());
          saveToHistory();
          showStatus(`🧹 Cleaned up ${dormantElements.length} elements!`, 3000, 'success');
          setTimeout(() => attachAllHandlers(doc), 100);
        }
      } else {
        showStatus('✨ Page is already clean!', 2000, 'info');
      }
    }

    // Bulk styling functions
    function setupBulkStylingButtons(overlay, currentEl, doc) {
      const applyToSameBgColor = overlay.querySelector('#applyToSameBgColor');
      const applyToSameTextColor = overlay.querySelector('#applyToSameTextColor');
      const applyToSameTag = overlay.querySelector('#applyToSameTag');
      
      applyToSameBgColor.onclick = () => {
        const currentBgColor = window.getComputedStyle(currentEl).backgroundColor;
        const similarElements = findElementsWithSameBackground(doc, currentBgColor);
        showBulkStylingConfirmation(similarElements, 'background color', () => {
          applyBulkStyling(similarElements, 'background');
        });
      };
      
      applyToSameTextColor.onclick = () => {
        const currentTextColor = window.getComputedStyle(currentEl).color;
        const similarElements = findElementsWithSameTextColor(doc, currentTextColor);
        showBulkStylingConfirmation(similarElements, 'text color', () => {
          applyBulkStyling(similarElements, 'text');
        });
      };
      
      applyToSameTag.onclick = () => {
        const currentTag = currentEl.tagName.toLowerCase();
        const similarElements = findElementsWithSameTag(doc, currentTag);
        showBulkStylingConfirmation(similarElements, 'tag type', () => {
          applyBulkStyling(similarElements, 'tag');
        });
      };
    }

    function findElementsWithSameBackground(doc, targetColor) {
      const elements = doc.querySelectorAll('*');
      const similarElements = [];
      
      elements.forEach(el => {
        const bgColor = window.getComputedStyle(el).backgroundColor;
        if (bgColor === targetColor && el !== doc.body && el !== doc.documentElement) {
          similarElements.push(el);
        }
      });
      
      return similarElements;
    }

    function findElementsWithSameTextColor(doc, targetColor) {
      const elements = doc.querySelectorAll('*');
      const similarElements = [];
      
      elements.forEach(el => {
        const textColor = window.getComputedStyle(el).color;
        if (textColor === targetColor && el !== doc.body && el !== doc.documentElement) {
          similarElements.push(el);
        }
      });
      
      return similarElements;
    }

    function findElementsWithSameTag(doc, targetTag) {
      return Array.from(doc.querySelectorAll(targetTag));
    }

    function showBulkStylingConfirmation(elements, type, onConfirm) {
      if (elements.length === 0) {
        showStatus(`❌ No elements found with the same ${type}`, 3000, 'warning');
        return;
      }
      
      const count = elements.length;
      const message = `🎨 Apply styling to ${count} element${count > 1 ? 's' : ''} with the same ${type}?`;
      
      if (confirm(message)) {
        onConfirm();
        showStatus(`✅ Applied styling to ${count} element${count > 1 ? 's' : ''}!`, 3000, 'success');
      }
    }

    function applyBulkStyling(elements, type) {
      const overlay = document.querySelector('.edit-overlay');
      const bgColorInput = overlay.querySelector('#bgColorInput');
      const textColorInput = overlay.querySelector('#textColorInput');
      const fontSizeInput = overlay.querySelector('#fontSizeInput');
      
      elements.forEach(el => {
        if (bgColorInput.value && (type === 'background' || type === 'tag')) {
          el.style.backgroundColor = bgColorInput.value;
        }
        if (textColorInput.value && (type === 'text' || type === 'tag')) {
          el.style.color = textColorInput.value;
        }
        if (fontSizeInput.value && type === 'tag') {
          el.style.fontSize = fontSizeInput.value;
        }
      });
      
      // Reattach handlers after styling
      setTimeout(() => {
        attachAllHandlers(frame.contentDocument || frame.contentWindow.document);
        saveToHistory();
      }, 100);
    }

    function showProgress(progress) {
      const progressBar = document.querySelector('.progress-bar');
      progressBar.style.width = `${progress}%`;
      
      if (progress >= 100) {
        setTimeout(() => {
          progressBar.style.width = '0%';
        }, 1000);
      }
    }



    // Global helper functions for settings
    // FIXED: Added z-index handling for settings popup functions to ensure they appear above all other elements
    function saveWorkFromSettings() {
      console.log('saveWorkFromSettings called');
      
      // Debug z-index conflicts before creating popup
      debugZIndexConflicts();
      
      // Create popup for custom label with dynamic z-index
      const { overlay, backdrop } = createPopupWithZIndex();
      
      // Add version-specific classes for proper z-index handling
      overlay.className = 'edit-overlay version-popup';
      backdrop.className = 'edit-backdrop version-backdrop';
      
      console.log('📋 Save work popup created with classes:', overlay.className, backdrop.className);
      
      overlay.innerHTML = `
        <h3>💾 Save Work</h3>
        <p>Enter a label for this saved work:</p>
        <input type="text" id="saveWorkLabel" placeholder="e.g., 'Homepage with new header'" style="width: 100%; padding: 12px; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; background: rgba(0,0,0,0.8); color: white; font-size: 14px; margin: 10px 0; outline: none;">
        <div class="button-group">
          <button onclick="saveWorkWithLabel()" class="primary">Save Work</button>
          <button onclick="closePopup();" class="secondary">Cancel</button>
        </div>
      `;
      
      document.body.append(backdrop, overlay);
      
      // Force the popup to be on top
      setTimeout(() => {
        overlay.style.zIndex = '999999999 !important';
        backdrop.style.zIndex = '999999998 !important';
        overlay.style.position = 'fixed !important';
        overlay.style.top = '50% !important';
        overlay.style.left = '50% !important';
        overlay.style.transform = 'translate(-50%, -50%) !important';
        console.log('📋 Save work popup positioned and should be visible');
      }, 10);
      
      // Focus on input
      setTimeout(() => {
        document.getElementById('saveWorkLabel').focus();
      }, 100);
      
      // Close on backdrop click
      backdrop.onclick = () => {
        overlay.remove();
        backdrop.remove();
      };
      
      // Close on Enter key
      document.getElementById('saveWorkLabel').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          saveWorkWithLabel();
        }
      });
      
      showStatus('💾 Save work popup opened!', 2000, 'info');
    }

    function publishFromSettings() {
      console.log('publishFromSettings called');
      if (confirm('⚠️ This will publish your changes to the live website. Are you sure you want to commit to the main files?')) {
        const publishBtn = document.getElementById('publishBtn');
        if (publishBtn) {
          // Trigger the publish function directly
          publishBtn.click();
          showStatus('🌐 Publish initiated!', 2000, 'info');
        } else {
          showStatus('❌ Publish button not found!', 2000, 'error');
        }
      }
    }

    function toggleDormantFromSettings() {
      console.log('toggleDormantFromSettings called');
      
      // Find the main dormant button - try multiple selectors
      let dormantBtn = document.querySelector('button[style*="Hide Dormant"], button[style*="Show Dormant"]');
      if (!dormantBtn) {
        // Try finding by text content
        const allButtons = document.querySelectorAll('button');
        dormantBtn = Array.from(allButtons).find(btn => 
          btn.textContent.includes('Hide Dormant') || btn.textContent.includes('Show Dormant')
        );
      }
      
      if (dormantBtn) {
        console.log('Found main dormant button, clicking it');
        dormantBtn.click();
        
        // Update the settings button text based on the main button
        setTimeout(() => {
          const settingsBtn = document.getElementById('settingsDormantToggleBtn');
          if (settingsBtn) {
            const mainBtnText = dormantBtn.textContent;
            if (mainBtnText.includes('Show')) {
              settingsBtn.textContent = '🙈 Hide Dormant';
            } else {
              settingsBtn.textContent = '👁️ Show Dormant';
            }
          }
        }, 100);
        
        showStatus('👁️ Dormant toggle activated!', 2000, 'info');
      } else {
        console.log('No main dormant button found, using fallback');
        // Fallback: toggle dormant elements directly
        const doc = frame.contentDocument || frame.contentWindow.document;
        const dormantElements = doc.querySelectorAll('.dormant');
        if (dormantElements.length > 0) {
          dormantVisible = !dormantVisible;
          showDormantElements(dormantVisible);
          
          // Update the settings button text
          const settingsBtn = document.getElementById('settingsDormantToggleBtn');
          if (settingsBtn) {
            settingsBtn.textContent = dormantVisible ? '🙈 Hide Dormant' : '👁️ Show Dormant';
          }
          
          showStatus(`👁️ Dormant elements ${dormantVisible ? 'shown' : 'hidden'}!`, 2000, 'info');
        } else {
          showStatus('⚠️ No dormant elements found', 2000, 'warning');
        }
      }
    }

    function resetFromSettings() {
      if (confirm('This will reload the page and reset all changes. Continue?')) {
        loadHTML();
        history = [];
        historyIndex = -1;
        document.getElementById('undoBtn').disabled = true;
        showStatus('🔄 Page reloaded and history reset!', 3000, 'info');
      }
    }

    function switchPageFromSettings() {
      console.log('switchPageFromSettings called');
      const selectedPage = document.getElementById('settingsPageSelect').value;
      console.log('Selected page:', selectedPage);
      console.log('Current FILE_PATH:', FILE_PATH);
      if (selectedPage !== FILE_PATH) {
        console.log('Switching to:', selectedPage);
        switchPage(selectedPage);
        closePopup();
        showStatus(`📄 Switched to: ${selectedPage}`, 3000, 'success');
      } else {
        console.log('Same page selected, no switch needed');
        showStatus('📄 Already on selected page', 2000, 'info');
      }
    }



    function viewVersionsFromSettings() {
      console.log('viewVersionsFromSettings called');
      closePopup();
      // Trigger the view versions popup
      setTimeout(() => {
        showViewVersionsPopup();
      }, 100);
    }

    // Settings button functionality
    document.getElementById('helpBtn').onclick = () => {
      console.log('Settings button clicked!');
      
      // Remove any existing popups
      document.querySelectorAll('.edit-backdrop, .edit-overlay').forEach(x => x.remove());

      const { overlay: overlayBox, backdrop } = createPopupWithZIndex();

      overlayBox.innerHTML = `
        <div style="text-align: center; margin-bottom: 40px;">
          <h3 style="margin: 0; color: #ffffff; font-size: 32px; font-weight: 800; text-transform: uppercase; letter-spacing: 3px;">⚙️ Settings</h3>
          <div style="font-size: 18px; color: #ffffff; margin-top: 12px; font-weight: 500; letter-spacing: 0.5px;">Manage your editor preferences and tools</div>
        </div>
        
        <div style="background: #000000; padding: 25px; border-radius: 16px; color: white; margin-bottom: 30px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); border: 2px solid #dc3545;">
          <div style="display: flex; align-items: center; margin-bottom: 20px;">
            <div style="font-size: 24px; margin-right: 12px;">📄</div>
            <h4 style="margin: 0; font-weight: 700; font-size: 18px; text-transform: uppercase; letter-spacing: 0.5px;">Page Selection</h4>
          </div>
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">Current Page:</label>
            <select id="settingsPageSelect" style="width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #dc3545; background: #000000; color: #ffffff; font-weight: 700; font-size: 15px; box-shadow: 0 2px 8px rgba(220,53,69,0.2); text-transform: uppercase; letter-spacing: 0.5px;">
            </select>
          </div>
          <button onclick="switchPageFromSettings();" style="width: 100%; padding: 14px; background: #000000; border: 2px solid #dc3545; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; transition: all 0.3s ease; font-size: 15px; text-transform: uppercase; letter-spacing: 0.5px;">Switch Page</button>
        </div>
        
        <div style="background: #000000; padding: 25px; border-radius: 16px; color: white; margin-bottom: 30px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); border: 2px solid #dc3545;">
          <div style="display: flex; align-items: center; margin-bottom: 20px;">
            <div style="font-size: 24px; margin-right: 12px;">📁</div>
            <h4 style="margin: 0; font-weight: 700; font-size: 18px; text-transform: uppercase; letter-spacing: 0.5px;">Version Management</h4>
          </div>
          <div style="margin-bottom: 15px;">
            <button onclick="showSaveVersionPopup();" style="width: 100%; padding: 14px; background: #000000; border: 2px solid #dc3545; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; transition: all 0.3s ease; margin-bottom: 12px; font-size: 15px; text-transform: uppercase; letter-spacing: 0.5px;">💾 Save Version</button>
            <button onclick="viewVersionsFromSettings();" style="width: 100%; padding: 14px; background: #000000; border: 2px solid #dc3545; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; transition: all 0.3s ease; font-size: 15px; text-transform: uppercase; letter-spacing: 0.5px;">👁️ View Versions</button>
          </div>
        </div>
        
        <!-- Quick Actions -->
        <div style="background: #000000; padding: 25px; border-radius: 16px; color: white; margin-bottom: 30px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); border: 2px solid #dc3545;">
          <div style="display: flex; align-items: center; margin-bottom: 20px;">
            <div style="font-size: 24px; margin-right: 12px;">⚡</div>
            <h4 style="margin: 0; font-weight: 700; font-size: 18px; text-transform: uppercase; letter-spacing: 0.5px;">Quick Actions</h4>
          </div>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
            <button onclick="console.log('Save Work clicked'); saveWorkFromSettings();" style="padding: 14px 10px; background: #000000; border: 2px solid #dc3545; border-radius: 12px; color: white; font-weight: 700; cursor: pointer; font-size: 14px; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;">💾 Save Work</button>
            <button onclick="publishFromSettings();" style="padding: 14px 10px; background: #000000; border: 2px solid #dc3545; border-radius: 12px; color: white; font-weight: 700; cursor: pointer; font-size: 14px; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;">🌐 Publish</button>
            <button onclick="loadHTML(); showStatus('🔄 Page reloaded!', 2000, 'info');" style="padding: 14px 10px; background: #000000; border: 2px solid #dc3545; border-radius: 12px; color: white; font-weight: 700; cursor: pointer; font-size: 14px; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;">🔄 Reload</button>
            <button id="settingsDormantToggleBtn" onclick="toggleDormantFromSettings();" style="padding: 14px 10px; background: #000000; border: 2px solid #dc3545; border-radius: 12px; color: white; font-weight: 700; cursor: pointer; font-size: 14px; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;">👁️ Dormant</button>
            <button onclick="copyPageUrl();" style="padding: 14px 10px; background: #000000; border: 2px solid #dc3545; border-radius: 12px; color: white; font-weight: 700; cursor: pointer; font-size: 14px; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;">🔗 Copy URL</button>
            <button onclick="toggleDarkMode();" style="padding: 14px 10px; background: #000000; border: 2px solid #dc3545; border-radius: 12px; color: white; font-weight: 700; cursor: pointer; font-size: 14px; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;">🌙 Dark</button>
            <button onclick="showPageStats();" style="padding: 14px 10px; background: #000000; border: 2px solid #dc3545; border-radius: 12px; color: white; font-weight: 700; cursor: pointer; font-size: 14px; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;">📊 Stats</button>
            <button onclick="loadSavedWork();" style="padding: 14px 10px; background: #000000; border: 2px solid #dc3545; border-radius: 12px; color: white; font-weight: 700; cursor: pointer; font-size: 14px; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;">📂 Load Work</button>
            <button onclick="resetFromSettings();" style="padding: 14px 10px; background: #000000; border: 2px solid #dc3545; border-radius: 12px; color: white; font-weight: 700; cursor: pointer; font-size: 14px; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;">🔄 Reset</button>
            <button onclick="showHelp();" style="padding: 14px 10px; background: #000000; border: 2px solid #dc3545; border-radius: 12px; color: white; font-weight: 700; cursor: pointer; font-size: 14px; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;">❓ Help</button>
          </div>
        </div>
        
        <!-- Help Section -->
        <div style="background: #000000; padding: 25px; border-radius: 16px; color: white; margin-bottom: 30px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); border: 2px solid #dc3545;">
          <div style="display: flex; align-items: center; margin-bottom: 20px;">
            <div style="font-size: 24px; margin-right: 12px;">❓</div>
            <h4 style="margin: 0; font-weight: 700; font-size: 18px; text-transform: uppercase; letter-spacing: 0.5px;">Help & Shortcuts</h4>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 14px;">
            <div>
              <div style="font-weight: 700; margin-bottom: 12px; font-size: 15px; text-transform: uppercase; letter-spacing: 0.5px;">⌨️ Keyboard Shortcuts:</div>
              <div style="line-height: 1.8;">
                <div><strong>Ctrl+S:</strong> Save Work</div>
                <div><strong>Ctrl+Shift+S:</strong> Publish</div>
                <div><strong>Ctrl+Shift+V:</strong> Save Version</div>
                <div><strong>Ctrl+Shift+A:</strong> Quick Actions</div>
                <div><strong>Ctrl+R:</strong> Reload</div>
                <div><strong>F1:</strong> Settings</div>
              </div>
            </div>
            <div>
              <div style="font-weight: 700; margin-bottom: 12px; font-size: 15px; text-transform: uppercase; letter-spacing: 0.5px;">🛠️ Quick Actions:</div>
              <div style="line-height: 1.8;">
                <div><strong>📝 Lorem:</strong> Add sample text</div>
                <div><strong>↶ Undo:</strong> Revert changes</div>
                <div><strong>🔄 Reload:</strong> Refresh page</div>
                <div><strong>🔗 Copy URL:</strong> Copy current URL</div>
                <div><strong>👁️ Toggle:</strong> Toggle elements</div>
                <div><strong>🌙 Dark:</strong> Toggle dark mode</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="button-group" style="text-align: center;">
          <button onclick="console.log('Close button clicked'); closePopup();" style="padding: 16px 32px; background: #dc3545; border: none; border-radius: 12px; color: white; font-weight: 700; cursor: pointer; font-size: 16px; transition: all 0.3s ease; box-shadow: 0 4px 16px rgba(220, 53, 69, 0.3); text-transform: uppercase; letter-spacing: 0.5px;">Close Settings</button>
        </div>
      `;

      document.body.append(backdrop, overlayBox);
      
      // Apply ergonomic styling to the popup
      overlayBox.style.maxWidth = '1000px';
      overlayBox.style.width = '98vw';
      overlayBox.style.maxHeight = '90vh';
      overlayBox.style.overflow = 'auto';
      overlayBox.style.position = 'fixed';
      overlayBox.style.top = '50%';
      overlayBox.style.left = '50%';
      overlayBox.style.transform = 'translate(-50%, -50%)';
      overlayBox.style.zIndex = '10002'; // Higher than shortcuts
      overlayBox.style.background = '#000000';
      overlayBox.style.backdropFilter = 'blur(25px) saturate(1.2)';
      overlayBox.style.border = '2px solid #dc3545';
      overlayBox.style.boxShadow = '0 25px 80px rgba(0,0,0,0.15), 0 8px 32px rgba(0,0,0,0.1)';
      overlayBox.style.borderRadius = '24px';
      overlayBox.style.padding = '40px';
      overlayBox.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';

      // Populate the page selection dropdown
      const settingsPageSelect = document.getElementById('settingsPageSelect');
      if (settingsPageSelect) {
        settingsPageSelect.innerHTML = '';
        AVAILABLE_PAGES.forEach(page => {
          const option = document.createElement('option');
          option.value = page;
          option.textContent = page;
          if (page === FILE_PATH) {
            option.selected = true;
          }
          settingsPageSelect.appendChild(option);
        });
        console.log('Populated settings page select with', AVAILABLE_PAGES.length, 'pages');
      }

      // Close button functionality
      document.getElementById('settingsCloseBtn').onclick = () => {
        console.log('Settings close button clicked!');
        closePopup();
      };

      // Quick actions are now handled by inline onclick handlers

      // Exit preview functionality
      if (isPreviewMode) {
        document.getElementById('exitPreviewBtn').onclick = () => {
          closePopup();
          exitPreviewMode();
        };
      }

              // Quick actions are now handled by inline onclick handlers
      


      backdrop.onclick = () => {
        console.log('Settings backdrop clicked');
        closePopup();
      };
      
      // Prevent backdrop click when clicking on the overlay
      overlayBox.onclick = (e) => {
        e.stopPropagation();
      };
    };

    // Helper function for save version popup
    function showSaveVersionPopup() {
      console.log('🔄 showSaveVersionPopup called');
      
      // Debug z-index conflicts before creating popup
      debugZIndexConflicts();
      
      const { overlay, backdrop } = createPopupWithZIndex();
      
      // Add version-specific classes for proper z-index handling
      overlay.className = 'edit-overlay version-popup';
      backdrop.className = 'edit-backdrop version-backdrop';
      
      console.log('📋 Version popup created with classes:', overlay.className, backdrop.className);
      
      overlay.innerHTML = `
        <div style="text-align: center; margin-bottom: 25px;">
                      <h3 style="margin: 0; color: #ffffff; font-size: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">📁 Save Version</h3>
                      <div style="font-size: 12px; color: #ffffff; margin-top: 5px; font-weight: 500;">Create a labeled version of the current page</div>
        </div>
        <div style="margin-bottom: 20px;">
                      <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #ffffff;">Version Label:</label>
          <input type="text" id="versionLabel" placeholder="e.g., mobile-layout, dark-theme, final" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px; outline: none; transition: border-color 0.3s ease;">
        </div>
        <div style="margin-bottom: 20px;">
                      <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #ffffff;">Description (optional):</label>
          <textarea id="versionDescription" placeholder="Brief description of this version..." style="width: 100%; padding: 12px; border: 2px solid #dc3545; border-radius: 8px; font-size: 14px; outline: none; transition: border-color 0.3s ease; resize: vertical; min-height: 80px; background: #000000; color: #ffffff;"></textarea>
        </div>
        <div style="padding: 15px; background: linear-gradient(135deg, #fff3e0, #ffe0b2); border-radius: 12px; border-left: 4px solid #fd7e14; margin-bottom: 20px;">
          <div style="font-weight: 600; color: #e55a00; margin-bottom: 8px;">💡 Info:</div>
          <div style="font-size: 12px; color: #f57c00; line-height: 1.4;">
            This will save the current page as a separate file in your GitHub repository. The file will be named: <strong>${FILE_PATH.replace('.html', '')}-{label}.html</strong>
          </div>
        </div>
        <div class="button-group">
          <button onclick="saveVersionToGitHub();" class="primary">Save Version</button>
          <button onclick="closePopup();" class="secondary">Cancel</button>
        </div>
      `;
      
      document.body.append(backdrop, overlay);
      
      // Force the popup to be on top
      setTimeout(() => {
        overlay.style.zIndex = '999999999 !important';
        backdrop.style.zIndex = '999999998 !important';
        overlay.style.position = 'fixed !important';
        overlay.style.top = '50% !important';
        overlay.style.left = '50% !important';
        overlay.style.transform = 'translate(-50%, -50%) !important';
        console.log('📋 Version popup positioned and should be visible');
      }, 10);
      
      // Focus on the label input
      setTimeout(() => {
        document.getElementById('versionLabel').focus();
      }, 100);
      
      backdrop.onclick = () => {
        overlay.remove();
        backdrop.remove();
      };
    }

    // Helper function for view versions popup
    async function showViewVersionsPopup() {
      console.log('🔄 showViewVersionsPopup called');
      
      // Debug z-index conflicts before creating popup
      debugZIndexConflicts();
      
      try {
        // Show loading state
        showStatus('⏳ Loading versions...', 0, 'info');
        
        // Fetch available versions from GitHub
        const versions = await fetchAvailableVersions();
        
        if (versions.length === 0) {
          showStatus('📁 No saved versions found for this page', 3000, 'info');
          return;
        }
        
        // Create popup to show available versions
        const { overlay, backdrop } = createPopupWithZIndex();
        
        // Add version-specific classes for proper z-index handling
        overlay.className = 'edit-overlay version-popup';
        backdrop.className = 'edit-backdrop version-backdrop';
        
        console.log('📋 View versions popup created with classes:', overlay.className, backdrop.className);
        
        overlay.innerHTML = `
          <div style="text-align: center; margin-bottom: 25px;">
            <h3 style="margin: 0; color: #ffffff; font-size: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">👁️ View Versions</h3>
                          <div style="font-size: 12px; color: #ffffff; margin-top: 5px; font-weight: 500;">Manage your saved versions</div>
          </div>
          <div style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
            ${versions.map(version => `
              <div class="version-item" data-filename="${version.name}" style="padding: 15px; margin: 8px 0; border: 2px solid #dc3545; border-radius: 12px; background: #000000; transition: all 0.3s ease; position: relative;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div style="flex: 1;">
                    <div style="font-weight: 600; color: #ffffff; font-size: 14px;">${version.name}</div>
                                          <div style="font-size: 12px; color: #ffffff; margin-top: 2px;">${version.commitMessage}</div>
                      <div style="font-size: 11px; color: #ffffff; margin-top: 2px;">${new Date(version.lastModified).toLocaleString()}</div>
                  </div>
                  <div style="display: flex; gap: 8px; align-items: center;">
                    <button class="load-version-btn" data-filename="${version.name}" style="padding: 6px 12px; background: linear-gradient(135deg, #fd7e14, #e55a00); color: white; border: none; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">Load</button>
                    <button class="delete-version-btn" data-filename="${version.name}" style="padding: 6px 12px; background: linear-gradient(135deg, #dc3545, #c82333); color: white; border: none; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">Delete</button>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
          <div style="padding: 15px; background: #000000; border-radius: 12px; border-left: 4px solid #dc3545; margin-bottom: 20px; border: 2px solid #dc3545;">
            <div style="font-weight: 700; color: #ffffff; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">💡 Actions:</div>
            <div style="font-size: 12px; color: #ffffff; line-height: 1.4;">
              • <strong>Load:</strong> Replace current page with this version<br>
              • <strong>Delete:</strong> Remove this version file from GitHub<br>
              • Only version files (with dashes) can be deleted
            </div>
          </div>
          <div class="button-group">
            <button onclick="this.closest('.edit-overlay').remove(); this.closest('.edit-backdrop').remove();" class="secondary">Close</button>
          </div>
        `;
        
        document.body.append(backdrop, overlay);
        
        // Force the popup to be on top
        setTimeout(() => {
          overlay.style.zIndex = '999999999 !important';
          backdrop.style.zIndex = '999999998 !important';
          overlay.style.position = 'fixed !important';
          overlay.style.top = '50% !important';
          overlay.style.left = '50% !important';
          overlay.style.transform = 'translate(-50%, -50%) !important';
          console.log('📋 View versions popup positioned and should be visible');
        }, 10);
        
        // Add click handlers for load buttons
        overlay.querySelectorAll('.load-version-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const filename = btn.getAttribute('data-filename');
            if (confirm(`👁️ This will load "${filename}" as a preview. You can review it and then save/publish to make it active. Continue?`)) {
              loadVersionPreview(filename);
              overlay.remove();
              backdrop.remove();
            }
          });
        });
        
        // Add click handlers for delete buttons
        overlay.querySelectorAll('.delete-version-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const filename = btn.getAttribute('data-filename');
            if (confirm(`🗑️ Are you sure you want to delete "${filename}"? This action cannot be undone.`)) {
              deleteVersionFromGitHub(filename);
              // Refresh the versions list
              setTimeout(() => {
                showViewVersionsPopup();
              }, 1000);
            }
          });
        });
        
        // Close on backdrop click
        backdrop.onclick = () => {
          overlay.remove();
          backdrop.remove();
        };
        
      } catch (error) {
        console.error('View versions error:', error);
        showStatus(`❌ Failed to load versions: ${error.message}`, 4000, 'error');
      }
    }



    // Add preview indicator
    function addPreviewIndicator() {
      // Remove existing indicator
      const existingIndicator = document.getElementById('previewIndicator');
      if (existingIndicator) {
        existingIndicator.remove();
      }
      
      // Create preview indicator
      const indicator = document.createElement('div');
      indicator.id = 'previewIndicator';
      indicator.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        font-weight: 700;
        font-size: 14px;
        z-index: 10002;
        box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        border: 2px solid rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(15px);
        animation: slideIn 0.4s ease-out;
        display: flex;
        align-items: center;
        gap: 10px;
      `;
      
      indicator.innerHTML = `
        <div style="font-size: 16px;">👁️</div>
        <div>
          <div style="font-weight: 700;">Preview Mode</div>
          <div style="font-size: 11px; opacity: 0.9;">${previewFilename}</div>
        </div>
        <button onclick="exitPreviewMode()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; margin-left: 10px;">Exit</button>
      `;
      
      document.body.appendChild(indicator);
    }

    // Exit preview mode
    function exitPreviewMode() {
      if (originalContent) {
        // Restore original content with data attributes
        let originalContentWithAttr = prepareIframeHTML(originalContent);
        frame.srcdoc = originalContentWithAttr;
        
        frame.onload = () => {
          const doc = frame.contentDocument || frame.contentWindow.document;
          attachAllHandlers(doc);
          showDormantElements(dormantVisible);
          
          // Reset preview state
          isPreviewMode = false;
          previewFilename = null;
          originalContent = null;
          
          // Remove preview indicator
          const indicator = document.getElementById('previewIndicator');
          if (indicator) {
            indicator.remove();
          }
          
          showStatus('↩️ Exited preview mode', 3000, 'info');
        };
      }
    }

    // Lorem Ipsum button functionality
    document.getElementById('loremBtn').onclick = () => {
      // Remove any existing popups
      document.querySelectorAll('.edit-backdrop, .edit-overlay').forEach(x => x.remove());

      const { overlay: overlayBox, backdrop } = createPopupWithZIndex();

      overlayBox.innerHTML = `
        <h3>📝 Lorem Ipsum Content</h3>
        <div style="max-height: 400px; overflow-y: auto; padding: 20px; background: #000000; border-radius: 8px; margin: 15px 0; border: 2px solid #dc3545;">
                      <p style="color: #ffffff;"><strong>Lorem ipsum dolor sit amet</strong>, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
          
                      <p style="color: #ffffff;">Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
          
                      <p style="color: #ffffff;">Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.</p>
          
                      <p style="color: #ffffff;">Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione voluptatem sequi nesciunt.</p>
          
                      <p style="color: #ffffff;">Neque porro quisquam est, qui dolorem ipsum quia dolor sit amet, consectetur, adipisci velit, sed quia non numquam eius modi tempora incidunt ut labore et dolore magnam aliquam quaerat voluptatem.</p>
          
                      <p style="color: #ffffff;">Ut enim ad minima veniam, quis nostrum exercitationem ullam corporis suscipit laboriosam, nisi ut aliquid ex ea commodi consequatur? Quis autem vel eum iure reprehenderit qui in ea voluptate velit esse quam nihil molestiae consequatur, vel illum qui dolorem eum fugiat quo voluptas nulla pariatur?</p>
          
                      <p style="color: #ffffff;">At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati cupiditate non provident, similique sunt in culpa qui officia deserunt mollitia animi, id est laborum et dolorum fuga.</p>
          
                      <p style="color: #ffffff;">Et harum quidem rerum facilis est et expedita distinctio. Nam libero tempore, cum soluta nobis est eligendi optio cumque nihil impedit quo minus id quod maxime placeat facere possimus, omnis voluptas assumenda est, omnis dolor repellendus.</p>
          
                      <p style="color: #ffffff;">Temporibus autem quibusdam et aut officiis debitis aut rerum necessitatibus saepe eveniet ut et voluptates repudiandae sint et molestiae non recusandae. Itaque earum rerum hic tenetur a sapiente delectus, ut aut reiciendis voluptatibus maiores alias consequatur aut perferendis doloribus asperiores repellat.</p>
          
                      <p style="color: #ffffff;">For more information, visit <a href="#" style="color: #dc3545; text-decoration: underline;">our website</a> or contact us at <a href="mailto:info@example.com" style="color: #dc3545; text-decoration: underline;">info@example.com</a>.</p>
          
                      <p style="color: #ffffff;">You can also check out our <a href="#" style="color: #dc3545; text-decoration: underline;">services page</a> and <a href="#" style="color: #dc3545; text-decoration: underline;">about us</a> for additional details.</p>
        </div>
        <div class="button-group">
          <button id="closeLorem" class="primary">Close</button>
        </div>
      `;

      document.body.append(backdrop, overlayBox);

      backdrop.onclick = () => {
        overlayBox.remove();
        backdrop.remove();
      };

      document.getElementById('closeLorem').onclick = () => {
        overlayBox.remove();
        backdrop.remove();
      };
    };









    // Undo functionality
    function saveToHistory() {
      const doc = frame.contentDocument || frame.contentWindow.document;
      if (!doc || !doc.documentElement) {
        console.log('❌ No document available for history save');
        return;
      }
      
      const html = doc.documentElement.outerHTML;
      console.log('💾 Saving to history. Current index:', historyIndex, 'History length:', history.length);
      
      // Remove current state and everything after it
      history = history.slice(0, historyIndex + 1);
      
      // Add new state
      history.push(html);
      historyIndex++;
      
      // Limit history size
      if (history.length > MAX_HISTORY) {
        history.shift();
        historyIndex--;
      }
      
      // Update undo button state
      const undoBtn = document.getElementById('undoBtn');
      undoBtn.disabled = historyIndex <= 0;
      
      console.log('✅ History saved. New index:', historyIndex, 'History length:', history.length, 'Button disabled:', undoBtn.disabled);
      
      // Add fancy visual feedback
      undoBtn.style.transform = 'scale(1.1)';
      undoBtn.style.boxShadow = '0 8px 25px rgba(108, 117, 125, 0.4)';
      setTimeout(() => {
        undoBtn.style.transform = '';
        undoBtn.style.boxShadow = '';
      }, 300);
    }

    // Ensure undo button is properly connected
    const undoBtn = document.getElementById('undoBtn');
    if (undoBtn) {
      console.log('🔧 Setting up undo button...');
      
      undoBtn.onclick = () => {
        console.log('🔄 Undo button clicked!');
        console.log('Current state:', {
          historyIndex,
          historyLength: history.length,
          isUndoing,
          frameExists: !!frame,
          frameSrc: frame ? frame.src : 'no frame',
          buttonDisabled: undoBtn.disabled
        });
        
        if (isUndoing) {
          showStatus('⏳ Undo in progress...', 2000, 'warning');
          return;
        }
        
        console.log('🔄 Undo clicked! History index:', historyIndex, 'History length:', history.length);
        
        if (historyIndex > 0) {
          isUndoing = true;
          historyIndex--;
          console.log('📋 Restoring to history index:', historyIndex);
          
          try {
            // Store the HTML we're about to restore
            const htmlToRestore = history[historyIndex];
            if (!htmlToRestore) {
              throw new Error('No HTML content in history at index ' + historyIndex);
            }
            console.log('📄 HTML length to restore:', htmlToRestore.length);
            
            // Get current scroll position before restoring
            const currentDoc = frame.contentDocument || frame.contentWindow.document;
            const currentScrollTop = currentDoc ? currentDoc.documentElement.scrollTop || currentDoc.body.scrollTop : 0;
            const currentScrollLeft = currentDoc ? currentDoc.documentElement.scrollLeft || currentDoc.body.scrollLeft : 0;
            
            console.log('📍 Preserving scroll position:', { top: currentScrollTop, left: currentScrollLeft });
            
            // Show loading state with fade effect
            showStatus('🔄 Restoring previous state...', 0, 'info');
            
            // Add smooth transition effect
            frame.style.opacity = '0.7';
            frame.style.transition = 'opacity 0.3s ease';
            
            // Apply to main frame with data attributes
            let htmlToRestoreWithAttr = prepareIframeHTML(htmlToRestore);
            frame.srcdoc = htmlToRestoreWithAttr;
            
            // Wait for the main frame to load
            frame.onload = () => {
              const doc = frame.contentDocument || frame.contentWindow.document;
              if (doc) {
                // Restore scroll position
                doc.documentElement.scrollTop = currentScrollTop;
                doc.documentElement.scrollLeft = currentScrollLeft;
                doc.body.scrollTop = currentScrollTop;
                doc.body.scrollLeft = currentScrollLeft;
                
                // Smooth fade-in effect
                frame.style.opacity = '1';
                
                // Reattach handlers
                attachAllHandlers(doc);
                showDormantElements(dormantVisible);
                
                // Update button state
                undoBtn.disabled = historyIndex <= 0;
                
                console.log('✅ Undo completed successfully with scroll restored');
                showStatus('↶ Undone!', 2000, 'info');
                isUndoing = false;
              }
            };
          } catch (error) {
            console.error('❌ Error during undo:', error);
            showStatus('❌ Undo failed: ' + error.message, 3000, 'error');
            isUndoing = false;
          }
        } else {
          console.log('❌ Nothing to undo - history index is 0');
          showStatus('❌ Nothing to undo', 2000, 'warning');
        }
      };
      
      console.log('✅ Undo button setup complete');
    } else {
      console.error('❌ Undo button not found!');
    }
        



    loadHTML();



    function insertEditableEmbed(container, embedUrl, width = "100%", height = "500px") {
      const doc = container.ownerDocument || document;

      console.log('Creating embed:', { embedUrl, width, height, container: container.tagName });

      // Clear the container completely if it's empty or only has whitespace
      if (!container.innerHTML.trim()) {
        container.innerHTML = '';
      } else {
        // Remove any existing iframes in the container
        const existingElements = container.querySelectorAll('iframe');
        console.log(`Removing ${existingElements.length} existing iframes from container`);
        Array.from(existingElements).forEach(el => el.remove());
      }

      // Create a wrapper div to hold the iframe and edit button
      const wrapper = doc.createElement('div');
      wrapper.style.position = 'relative';
      wrapper.style.display = 'inline-block';
      wrapper.style.width = width;
      wrapper.style.height = height;
      wrapper.style.maxWidth = '100%';

      // Create a simple, clean iframe
      const iframe = doc.createElement('iframe');
      iframe.src = embedUrl;
      iframe.style.width = '100%';
      iframe.style.height = '100%';
      iframe.style.border = "none";
      iframe.style.display = "block";
      iframe.style.margin = "0";
      iframe.style.boxSizing = "border-box";
      
      // Create a small edit button that appears in the top-right corner
      const editButton = doc.createElement('button');
      editButton.innerHTML = '✏️';
      editButton.style.position = 'absolute';
      editButton.style.top = '5px';
      editButton.style.right = '5px';
      editButton.style.zIndex = '1000';
      editButton.style.background = '#007bff';
      editButton.style.color = 'white';
      editButton.style.border = 'none';
      editButton.style.borderRadius = '3px';
      editButton.style.padding = '3px 6px';
      editButton.style.fontSize = '12px';
      editButton.style.cursor = 'pointer';
      editButton.style.opacity = '0';
      editButton.style.transition = 'opacity 0.2s ease';
      
      // Show button on hover
      wrapper.onmouseenter = () => {
        editButton.style.opacity = '1';
      };
      
      wrapper.onmouseleave = () => {
        editButton.style.opacity = '0';
      };
      
      // Add click handler to the edit button
      editButton.onclick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        // Show edit options
        doc.querySelectorAll('.edit-backdrop, .edit-overlay').forEach(x => x.remove());

        const overlayBox = doc.createElement('div');
        const backdrop = doc.createElement('div');
        
        // Set dynamic z-index for iframe context
        const popupZ = getNextPopupZIndex();
        const backdropZ = getNextBackdropZIndex();
        
        overlayBox.className = 'edit-overlay';
        backdrop.className = 'edit-backdrop';
        
        overlayBox.style.setProperty('--popup-z-index', popupZ);
        backdrop.style.setProperty('--backdrop-z-index', backdropZ);

        overlayBox.innerHTML = `
          <label>Edit Embed:</label>
          <select id="editChoice">
            <option value="">Cancel</option>
            <option value="remove">Remove Embed</option>
          </select>
          <button id="editOk">OK</button>
        `;

        document.body.append(backdrop, overlayBox);

        backdrop.onclick = () => {
          overlayBox.remove();
          backdrop.remove();
        };

        doc.getElementById('editOk').onclick = () => {
          const choice = doc.getElementById('editChoice').value;
          overlayBox.remove();
          backdrop.remove();

          if (choice === 'remove') {
            wrapper.remove();
            setTimeout(() => attachAllHandlers(doc), 0);
          }
        };
      };

      wrapper.appendChild(iframe);
      wrapper.appendChild(editButton);
      container.appendChild(wrapper);
    }
    function upgradeAllIframes(doc) {
      console.log('=== Starting iframe upgrade process ===');
      
      // First, clean any existing iframes that might have old editor attributes
      const existingIframes = doc.querySelectorAll('iframe');
      existingIframes.forEach(iframe => {
        // Remove any old editor attributes
        iframe.removeAttribute('data-embed-id');
        iframe.removeAttribute('data-editor-attached');
        iframe.classList.remove('editable-form-embed', 'editable-embed');
        
        // Clean up any old styles
        iframe.style.outline = '';
        iframe.style.transition = '';
        iframe.style.zIndex = '';
        iframe.style.pointerEvents = '';
      });
      
      // Find all iframes that need to be made editable
      let iframes = doc.querySelectorAll('iframe:not([data-editor-attached])');
      console.log(`Found ${iframes.length} iframes to make editable`);
      
      // Also check for any iframes that might be Google Forms
      const allIframes = doc.querySelectorAll('iframe');
      console.log(`Total iframes found: ${allIframes.length}`);
      allIframes.forEach((iframe, i) => {
        console.log(`Iframe ${i + 1}:`, {
          src: iframe.src,
          width: iframe.style.width || iframe.getAttribute('width'),
          height: iframe.style.height || iframe.getAttribute('height'),
          hasEditor: iframe.hasAttribute('data-editor-attached'),
          isGoogleForm: iframe.src && iframe.src.includes('docs.google.com')
        });
      });
      
      // If no iframes were found with the normal selector, try a more comprehensive approach
      if (iframes.length === 0 && allIframes.length > 0) {
        console.log('⚠️ No iframes found with normal selector, trying comprehensive approach...');
        iframes = Array.from(allIframes).filter(iframe => {
          // Check if iframe is not already wrapped in an editor
          const parent = iframe.parentElement;
          const hasEditButton = parent && parent.querySelector('button[style*="position: absolute"]');
          return !hasEditButton;
        });
        console.log(`Found ${iframes.length} iframes with comprehensive approach`);
      }
      
      iframes.forEach((iframe, index) => {
        const src = iframe.src || '';
        const parent = iframe.parentElement;
        
        // Get dimensions, preferring inline styles over attributes
        let width = iframe.style.width || iframe.getAttribute('width') || "100%";
        let height = iframe.style.height || iframe.getAttribute('height') || "500px";
        
        // Clean up dimension values
        if (width === 'medium' || width === '') width = "100%";
        if (height === 'medium' || height === '') height = "500px";
        
        console.log(`Making iframe ${index + 1} editable:`, { src, width, height });
        
        // Special handling for Google Forms
        const isGoogleForm = src.includes('docs.google.com');
        if (isGoogleForm) {
          console.log('🔍 Google Form detected:', src);
        }
        
        // Create a wrapper for this iframe
        const wrapper = doc.createElement('div');
        wrapper.style.position = 'relative';
        wrapper.style.display = 'inline-block';
        wrapper.style.width = width;
        wrapper.style.height = height;
        wrapper.style.maxWidth = '100%';
        
        // Apply proper styling to iframe
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        iframe.style.border = "none";
        iframe.style.display = "block";
        iframe.style.margin = "0";
        iframe.style.boxSizing = "border-box";
        
        // Create edit button
        const editButton = doc.createElement('button');
        editButton.innerHTML = '✏️';
        editButton.style.position = 'absolute';
        editButton.style.top = '5px';
        editButton.style.right = '5px';
        editButton.style.zIndex = '1000';
        editButton.style.background = '#007bff';
        editButton.style.color = 'white';
        editButton.style.border = 'none';
        editButton.style.borderRadius = '3px';
        editButton.style.padding = '3px 6px';
        editButton.style.fontSize = '12px';
        editButton.style.cursor = 'pointer';
        editButton.style.opacity = '0';
        editButton.style.transition = 'opacity 0.2s ease';
        
        // Show button on hover
        wrapper.onmouseenter = () => {
          editButton.style.opacity = '1';
        };
        
        wrapper.onmouseleave = () => {
          editButton.style.opacity = '0';
        };
        
        // Add click handler to the edit button
        editButton.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          doc.querySelectorAll('.edit-backdrop, .edit-overlay').forEach(x => x.remove());

          const overlayBox = doc.createElement('div');
          overlayBox.className = 'edit-overlay';
          const backdrop = doc.createElement('div');
          backdrop.className = 'edit-backdrop';

          overlayBox.innerHTML = `
            <h3>Edit Iframe</h3>
            <div class="form-group">
              <label for="iframeSrc">Source URL:</label>
              <input type="text" id="iframeSrc" value="${iframe.src || ''}" placeholder="Enter iframe URL">
            </div>
            <div class="form-group">
              <label for="iframeWidth">Width:</label>
              <input type="text" id="iframeWidth" value="${width}" placeholder="e.g., 100%, 500px">
            </div>
            <div class="form-group">
              <label for="iframeHeight">Height:</label>
              <input type="text" id="iframeHeight" value="${height}" placeholder="e.g., 500px, 100vh">
            </div>
            <div class="form-group">
              <label for="iframeTitle">Title (for accessibility):</label>
              <input type="text" id="iframeTitle" value="${iframe.title || ''}" placeholder="Enter iframe title">
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" id="makeDormant" ${iframe.classList.contains('dormant') ? 'checked' : ''}>
                Make Dormant (hide from normal view)
              </label>
            </div>
            <div class="button-group">
              <button id="editOk" class="primary">Apply Changes</button>
              <button id="editCancel" class="secondary">Cancel</button>
              <button id="removeIframe" class="danger">Remove Iframe</button>
            </div>
          `;

          document.body.append(backdrop, overlayBox);

          backdrop.onclick = () => {
            overlayBox.remove();
            backdrop.remove();
          };

          // Apply Changes button
          doc.getElementById('editOk').onclick = () => {
            const newSrc = doc.getElementById('iframeSrc').value;
            const newWidth = doc.getElementById('iframeWidth').value;
            const newHeight = doc.getElementById('iframeHeight').value;
            const newTitle = doc.getElementById('iframeTitle').value;
            const makeDormant = doc.getElementById('makeDormant').checked;
            
            // Update iframe properties
            if (newSrc) iframe.src = newSrc;
            if (newTitle) iframe.title = newTitle;
            
            // Update wrapper dimensions
            if (newWidth) wrapper.style.width = newWidth;
            if (newHeight) wrapper.style.height = newHeight;
            
            // Handle dormant state
            if (makeDormant) {
              iframe.classList.add('dormant');
              wrapper.classList.add('dormant');
            } else {
              iframe.classList.remove('dormant');
              wrapper.classList.remove('dormant');
            }
            
            overlayBox.remove();
            backdrop.remove();
            showStatus('✅ Iframe updated successfully', 2000, 'success');
          };
          
          // Cancel button
          doc.getElementById('editCancel').onclick = () => {
            overlayBox.remove();
            backdrop.remove();
          };
          
          // Remove iframe button
          doc.getElementById('removeIframe').onclick = () => {
            wrapper.remove();
            overlayBox.remove();
            backdrop.remove();
            setTimeout(() => attachAllHandlers(doc), 0);
            showStatus('🗑️ Iframe removed', 2000, 'info');
          };
        };
        
        // Move iframe into wrapper
        parent.insertBefore(wrapper, iframe);
        wrapper.appendChild(iframe);
        wrapper.appendChild(editButton);
      });
      
      console.log('=== Iframe upgrade complete ===');
    }
    
    // Special function to make Google Forms editable
    function makeGoogleFormsEditable(doc) {
      const googleForms = doc.querySelectorAll('iframe[src*="docs.google.com"]');
      console.log(`Found ${googleForms.length} Google Forms to make editable`);
      
      googleForms.forEach((iframe, index) => {
        console.log(`Making Google Form ${index + 1} editable:`, iframe.src);
        
        // Check if already has editor
        const parent = iframe.parentElement;
        const hasEditButton = parent && parent.querySelector('button[style*="position: absolute"]');
        
        if (!hasEditButton) {
          // Create wrapper and edit button for this Google Form
          const wrapper = doc.createElement('div');
          wrapper.style.position = 'relative';
          wrapper.style.display = 'inline-block';
          wrapper.style.width = iframe.style.width || iframe.getAttribute('width') || '100%';
          wrapper.style.height = iframe.style.height || iframe.getAttribute('height') || '500px';
          wrapper.style.maxWidth = '100%';
          
          // Style the iframe
          iframe.style.width = '100%';
          iframe.style.height = '100%';
          iframe.style.border = 'none';
          iframe.style.display = 'block';
          iframe.style.margin = '0';
          iframe.style.boxSizing = 'border-box';
          
          // Create edit button
          const editButton = doc.createElement('button');
          editButton.innerHTML = '✏️';
          editButton.style.position = 'absolute';
          editButton.style.top = '5px';
          editButton.style.right = '5px';
          editButton.style.zIndex = '1000';
          editButton.style.background = '#007bff';
          editButton.style.color = 'white';
          editButton.style.border = 'none';
          editButton.style.borderRadius = '3px';
          editButton.style.padding = '3px 6px';
          editButton.style.fontSize = '12px';
          editButton.style.cursor = 'pointer';
          editButton.style.opacity = '0';
          editButton.style.transition = 'opacity 0.2s ease';
          
          // Show button on hover
          wrapper.onmouseenter = () => {
            editButton.style.opacity = '1';
          };
          
          wrapper.onmouseleave = () => {
            editButton.style.opacity = '0';
          };
          
          // Add the same click handler as the main iframe editor
          editButton.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            doc.querySelectorAll('.edit-backdrop, .edit-overlay').forEach(x => x.remove());

            const overlayBox = doc.createElement('div');
            const backdrop = doc.createElement('div');
            
            // Set dynamic z-index for iframe context
            const popupZ = getNextPopupZIndex();
            const backdropZ = getNextBackdropZIndex();
            
            overlayBox.className = 'edit-overlay';
            backdrop.className = 'edit-backdrop';
            
            overlayBox.style.setProperty('--popup-z-index', popupZ);
            backdrop.style.setProperty('--backdrop-z-index', backdropZ);

            overlayBox.innerHTML = `
              <h3>Edit Google Form</h3>
              <div class="form-group">
                <label for="iframeSrc">Form URL:</label>
                <input type="text" id="iframeSrc" value="${iframe.src || ''}" placeholder="Enter Google Form URL">
              </div>
              <div class="form-group">
                <label for="iframeWidth">Width:</label>
                <input type="text" id="iframeWidth" value="${wrapper.style.width}" placeholder="e.g., 100%, 500px">
              </div>
              <div class="form-group">
                <label for="iframeHeight">Height:</label>
                <input type="text" id="iframeHeight" value="${wrapper.style.height}" placeholder="e.g., 500px, 100vh">
              </div>
              <div class="form-group">
                <label for="iframeTitle">Title (for accessibility):</label>
                <input type="text" id="iframeTitle" value="${iframe.title || ''}" placeholder="Enter form title">
              </div>
              <div class="form-group">
                <label>
                  <input type="checkbox" id="makeDormant" ${iframe.classList.contains('dormant') ? 'checked' : ''}>
                  Make Dormant (hide from normal view)
                </label>
              </div>
              <div class="button-group">
                <button id="editOk" class="primary">Apply Changes</button>
                <button id="editCancel" class="secondary">Cancel</button>
                <button id="removeIframe" class="danger">Remove Form</button>
              </div>
            `;

            document.body.append(backdrop, overlayBox);

            backdrop.onclick = () => {
              overlayBox.remove();
              backdrop.remove();
            };

            // Apply Changes button
            doc.getElementById('editOk').onclick = () => {
              const newSrc = doc.getElementById('iframeSrc').value;
              const newWidth = doc.getElementById('iframeWidth').value;
              const newHeight = doc.getElementById('iframeHeight').value;
              const newTitle = doc.getElementById('iframeTitle').value;
              const makeDormant = doc.getElementById('makeDormant').checked;
              
              // Update iframe properties
              if (newSrc) iframe.src = newSrc;
              if (newTitle) iframe.title = newTitle;
              
              // Update wrapper dimensions
              if (newWidth) wrapper.style.width = newWidth;
              if (newHeight) wrapper.style.height = newHeight;
              
              // Handle dormant state
              if (makeDormant) {
                iframe.classList.add('dormant');
                wrapper.classList.add('dormant');
              } else {
                iframe.classList.remove('dormant');
                wrapper.classList.remove('dormant');
              }
              
              overlayBox.remove();
              backdrop.remove();
              showStatus('✅ Google Form updated successfully', 2000, 'success');
            };
            
            // Cancel button
            doc.getElementById('editCancel').onclick = () => {
              overlayBox.remove();
              backdrop.remove();
            };
            
            // Remove iframe button
            doc.getElementById('removeIframe').onclick = () => {
              wrapper.remove();
              overlayBox.remove();
              backdrop.remove();
              setTimeout(() => attachAllHandlers(doc), 0);
              showStatus('🗑️ Google Form removed', 2000, 'info');
            };
          };
          
          // Move iframe into wrapper
          const parent = iframe.parentElement;
          parent.insertBefore(wrapper, iframe);
          wrapper.appendChild(iframe);
          wrapper.appendChild(editButton);
          
          console.log(`✅ Google Form ${index + 1} made editable`);
        }
      });
    }



  
    function attachAllHandlers(doc) {
      // ✅ First, upgrade any raw iframes to be editable
      upgradeAllIframes(doc);
      
      // ✅ Special handling for Google Forms
      makeGoogleFormsEditable(doc);

      // ✅ Remove old handlers
      doc.querySelectorAll('[data-editor-attached]').forEach(el => {
        el.removeAttribute('data-editor-attached');
        el.onclick = null;
      });

      const elements = doc.querySelectorAll('a,img,button,iframe,span,p,div,h1,h2,h3,h4,h5,h6,strong,b,em');

      elements.forEach(el => {
        const tag = el.tagName.toLowerCase();
        const text = el.innerText?.trim();
        const hasText = !!text;

        // ❌ Skip dormant unless revealed
        if (el.classList.contains('dormant') && !dormantVisible) return;






        // ❌ Skip large containers (with multiple children or nested blocks)
        const childTags = Array.from(el.children).map(c => c.tagName?.toLowerCase());
        const isAtomic = childTags.length <= 1 && !childTags.some(t => ['p', 'div', 'section', 'h1', 'h2', 'h3', 'h4'].includes(t));
        if (!['img', 'a', 'iframe', 'button'].includes(tag) && !isAtomic) return;

        el.setAttribute('data-editor-attached', 'yes');

        el.onclick = async e => {
          const iframeSpaceHeld = doc._iframeSpaceHeld || false;
          const fullSpaceHeld = spaceHeld || iframeSpaceHeld;

          // Smart element detection and feedback
          const detection = detectElementType(el);
          showStatus(`🎯 Editing ${detection.type}: ${el.innerText?.trim().substring(0, 20) || el.tagName}`, 2000, 'info');

          // 🔗 Identify editable attribute
          let attr = null;
          if (tag === 'a') attr = 'href';
          else if (['img', 'iframe'].includes(tag)) attr = 'src';
          else if (tag === 'button') {
            if (el.hasAttribute('href')) attr = 'href';
            else if (el.hasAttribute('data-link')) attr = 'data-link';
            else if (el.hasAttribute('onclick')) attr = 'onclick';
          }
          else if (tag === 'div' && el.hasAttribute('src')) {
            const innerA = el.querySelector('a');
            if (innerA) {
              attr = 'href';
              el = innerA; // now edits will target the <a>
            }
          }


          // ⌨️ Spacebar link follow behavior
          if (fullSpaceHeld && !spaceJustUsed) {
            spaceJustUsed = true;
            if (attr && el.getAttribute(attr)) {
              window.open(el.getAttribute(attr), '_blank');
            }
            return;
          }
          if (fullSpaceHeld) return;

          e.preventDefault();
          document.querySelectorAll('.edit-backdrop, .edit-overlay').forEach(x => x.remove());

          // 🧠 Build overlay with dynamic z-index
          const { overlay, backdrop } = createPopupWithZIndex();

          overlay.innerHTML = `
        <div style="text-align: center; margin-bottom: 25px;">
                      <h3 style="margin: 0; color: #ffffff; font-size: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Edit Element</h3>
                      <div style="font-size: 12px; color: #ffffff; margin-top: 5px; font-weight: 500;">Choose an action to perform</div>
        </div>
        <div class="edit-options-grid" style="gap: 12px;">
          <div class="edit-option enhanced-option" data-value="url">
            <div style="font-size: 28px; margin-bottom: 10px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">🔗</div>
            <div style="font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">URL/Link</div>
          </div>
          <div class="edit-option enhanced-option" data-value="text">
            <div style="font-size: 28px; margin-bottom: 10px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">📝</div>
            <div style="font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Text Content</div>
          </div>
          <div class="edit-option enhanced-option" data-value="browse">
            <div style="font-size: 28px; margin-bottom: 10px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">🖼️</div>
            <div style="font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Upload Image</div>
          </div>
          <div class="edit-option enhanced-option" data-value="style">
            <div style="font-size: 28px; margin-bottom: 10px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">🎨</div>
            <div style="font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Styling</div>
          </div>
          <div class="edit-option enhanced-option" data-value="googleform">
            <div style="font-size: 28px; margin-bottom: 10px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">📋</div>
            <div style="font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Google Form</div>
          </div>
          <div class="edit-option enhanced-option" data-value="youtube">
            <div style="font-size: 28px; margin-bottom: 10px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">🎬</div>
            <div style="font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">YouTube Video</div>
          </div>
          <div class="edit-option enhanced-option" data-value="copy">
            <div style="font-size: 28px; margin-bottom: 10px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">📋</div>
            <div style="font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Copy Element</div>
          </div>
          <div class="edit-option enhanced-option" data-value="dormant">
            <div style="font-size: 28px; margin-bottom: 10px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">👁️</div>
            <div style="font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Hide Element</div>
          </div>
          ${(el.classList.contains('dormant') || el.classList.contains('dormant-revealed')) ? 
            '<div class="edit-option enhanced-option" data-value="restore"><div style="font-size: 28px; margin-bottom: 10px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">🔄</div><div style="font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Restore</div></div>' : ''}
          <div class="edit-option enhanced-option" data-value="delete">
            <div style="font-size: 28px; margin-bottom: 10px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">🗑️</div>
            <div style="font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Delete</div>
          </div>
        </div>
        
        <div id="editDetails" style="display: none;">
          <div id="urlEdit" style="display: none;">
            <label style="color: #ffffff; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">URL/Link:</label>
            <input type="url" id="urlInput" placeholder="Enter URL..." style="width: 100%; padding: 12px 16px; border: 2px solid #dc3545; border-radius: 8px; font-size: 14px; margin-bottom: 15px; background: #000000; color: #ffffff;">
          </div>
          <div id="textEdit" style="display: none;">
            <label style="color: #ffffff; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Text Content:</label>
            <textarea id="textInput" rows="3" placeholder="Enter text..." style="width: 100%; padding: 12px 16px; border: 2px solid #dc3545; border-radius: 8px; font-size: 14px; margin-bottom: 15px; resize: vertical; background: #000000; color: #ffffff;"></textarea>
          </div>
          <div id="styleEdit" style="display: none;">
            <label style="color: #ffffff; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Background Color:</label>
            <input type="color" id="bgColorInput" style="width: 100%; height: 40px; border: 2px solid #dc3545; border-radius: 8px; margin-bottom: 15px;">
            <label style="color: #ffffff; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Text Color:</label>
            <input type="color" id="textColorInput" style="width: 100%; height: 40px; border: 2px solid #dc3545; border-radius: 8px; margin-bottom: 15px;">
            <label style="color: #ffffff; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Font Size:</label>
            <select id="fontSizeInput" style="width: 100%; padding: 12px 16px; border: 2px solid #dc3545; border-radius: 8px; font-size: 14px; margin-bottom: 15px; background: #000000; color: #ffffff;">
              <option value="">Keep current</option>
              <option value="12px">Small (12px)</option>
              <option value="14px">Normal (14px)</option>
              <option value="16px">Medium (16px)</option>
              <option value="18px">Large (18px)</option>
              <option value="24px">Extra Large (24px)</option>
              <option value="32px">Huge (32px)</option>
            </select>
            
            <div style="margin-top: 20px; padding: 15px; background: #000000; border-radius: 8px; border-left: 4px solid #dc3545; border: 2px solid #dc3545;">
              <label style="font-weight: 700; color: #ffffff; margin-bottom: 10px; display: block; text-transform: uppercase; letter-spacing: 0.5px;">🎨 Apply to Similar Elements:</label>
              <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button type="button" id="applyToSameBgColor" style="padding: 8px 12px; background: #000000; border: 2px solid #dc3545; border-radius: 6px; color: #ffffff; cursor: pointer; font-size: 12px; transition: all 0.3s ease; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Same Background</button>
                <button type="button" id="applyToSameTextColor" style="padding: 8px 12px; background: #000000; border: 2px solid #dc3545; border-radius: 6px; color: #ffffff; cursor: pointer; font-size: 12px; transition: all 0.3s ease; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Same Text Color</button>
                <button type="button" id="applyToSameTag" style="padding: 8px 12px; background: #000000; border: 2px solid #dc3545; border-radius: 6px; color: #ffffff; cursor: pointer; font-size: 12px; transition: all 0.3s ease; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Same Tag Type</button>
              </div>
              <div style="margin-top: 10px; font-size: 11px; color: #ffffff;">
                💡 Select one of these options to apply your changes to all similar elements
              </div>
            </div>
          </div>
          <div id="imageEdit" style="display: none;">
            <label style="color: #ffffff; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Upload New Image:</label>
            <input type="file" id="imgInput" accept="image/*" style="width: 100%; padding: 10px; border: 2px dashed #dc3545; border-radius: 8px; background: #000000; margin-top: 10px; cursor: pointer; color: #ffffff;">
            <div style="margin-top: 15px; padding: 15px; background: #000000; border-radius: 8px; border: 2px solid #dc3545;">
              <label style="color: #ffffff; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Or enter image URL:</label>
              <input type="url" id="imageUrlInput" placeholder="https://example.com/image.jpg" style="width: 100%; padding: 12px 16px; border: 2px solid #dc3545; border-radius: 8px; font-size: 14px; margin-top: 8px; background: #000000; color: #ffffff;">
            </div>
          </div>
          <div id="googleFormEdit" style="display: none;">
            <label style="color: #ffffff; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Google Form URL:</label>
            <input type="url" id="googleFormUrlInput" placeholder="https://docs.google.com/forms/d/e/..." style="width: 100%; padding: 12px 16px; border: 2px solid #dc3545; border-radius: 8px; font-size: 14px; margin-bottom: 15px; background: #000000; color: #ffffff;">
            <div style="padding: 10px; background: #000000; border-radius: 8px; font-size: 12px; color: #ffffff; border: 2px solid #dc3545;">
              💡 Tip: Paste your Google Form URL and it will be automatically embedded
            </div>
          </div>
          <div id="youtubeEdit" style="display: none;">
            <label>YouTube Video URL:</label>
            <input type="url" id="youtubeUrlInput" placeholder="https://www.youtube.com/watch?v=..." style="width: 100%; padding: 12px 16px; border: 2px solid #dc3545; border-radius: 8px; font-size: 14px; margin-bottom: 15px; background: #000000; color: #ffffff;">
            <div style="padding: 10px; background: #000000; border: 2px solid #dc3545; border-radius: 8px; font-size: 12px; color: #ffffff;">
              💡 Tip: Paste any YouTube video URL and it will be automatically embedded
            </div>
          </div>
        </div>
        
        <div style="text-align: center; margin-top: 20px; position: sticky; bottom: 0; padding: 15px 0; z-index: 2200;">
          <button id="editOk" class="primary" style="position: relative; z-index: 2200;">Apply Changes</button>
          <button id="editCancel" class="secondary" style="position: relative; z-index: 2200;">Cancel</button>
        </div>
      `;

          document.body.append(backdrop, overlay);
          
          // Handle option selection
          const options = overlay.querySelectorAll('.edit-option');
          const editDetails = overlay.querySelector('#editDetails');
          
          options.forEach(option => {
            option.addEventListener('click', () => {
              // Remove previous selection
              options.forEach(opt => opt.classList.remove('selected'));
              option.classList.add('selected');
              
              // Add visual feedback
              option.style.transform = 'scale(0.95)';
              setTimeout(() => {
                option.style.transform = '';
              }, 150);
              
              const value = option.getAttribute('data-value');
              showEditDetails(value);
            });
          });
          
          function showEditDetails(choice) {
            // Hide all detail sections
            overlay.querySelectorAll('#editDetails > div').forEach(div => div.style.display = 'none');
            editDetails.style.display = 'none';
            
            if (choice === 'url') {
              editDetails.style.display = 'block';
              overlay.querySelector('#urlEdit').style.display = 'block';
              const urlInput = overlay.querySelector('#urlInput');
              urlInput.value = el.getAttribute(attr || 'src') || '';
            } else if (choice === 'text') {
              editDetails.style.display = 'block';
              overlay.querySelector('#textEdit').style.display = 'block';
              const textInput = overlay.querySelector('#textInput');
              textInput.value = el.innerText.trim() || '';
            } else if (choice === 'style') {
              editDetails.style.display = 'block';
              overlay.querySelector('#styleEdit').style.display = 'block';
              const bgColorInput = overlay.querySelector('#bgColorInput');
              const textColorInput = overlay.querySelector('#textColorInput');
              const fontSizeInput = overlay.querySelector('#fontSizeInput');
              
              // Set current values
              const computedStyle = window.getComputedStyle(el);
              bgColorInput.value = rgbToHex(computedStyle.backgroundColor);
              textColorInput.value = rgbToHex(computedStyle.color);
              fontSizeInput.value = computedStyle.fontSize;
              
              // Add event listeners for bulk styling
              setupBulkStylingButtons(overlay, el, doc);
            } else if (choice === 'browse') {
              editDetails.style.display = 'block';
              overlay.querySelector('#imageEdit').style.display = 'block';
              const imageUrlInput = overlay.querySelector('#imageUrlInput');
              imageUrlInput.value = el.getAttribute(attr || 'src') || '';
            } else if (choice === 'googleform') {
              editDetails.style.display = 'block';
              overlay.querySelector('#googleFormEdit').style.display = 'block';
            } else if (choice === 'youtube') {
              editDetails.style.display = 'block';
              overlay.querySelector('#youtubeEdit').style.display = 'block';
            }
          }
          
          function rgbToHex(rgb) {
            if (!rgb || rgb === 'rgba(0, 0, 0, 0)' || rgb === 'transparent') return '#000000';
            const match = rgb.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)/);
            if (!match) return '#000000';
            const r = parseInt(match[1]);
            const g = parseInt(match[2]);
            const b = parseInt(match[3]);
            return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
          }
          
          backdrop.onclick = () => { overlay.remove(); backdrop.remove(); };
          overlay.querySelector('#editCancel').onclick = () => { overlay.remove(); backdrop.remove(); };

          document.getElementById('editOk').onclick = async () => {
            const selectedOption = overlay.querySelector('.edit-option.selected');
            if (!selectedOption) return;
            
            const choice = selectedOption.getAttribute('data-value');
            overlay.remove(); backdrop.remove();
            if (!choice) return;

            if (choice === 'url') {
              const urlInput = overlay.querySelector('#urlInput');
              const newVal = urlInput.value.trim();
              if (newVal) {
                if (tag === 'button') {
                  // Prefer data-link if present
                  if (el.hasAttribute('data-link')) {
                    el.setAttribute('data-link', newVal);
                  } else {
                    el.setAttribute('onclick', `location.href='${newVal}'`);
                  }
                } else {
                  el.setAttribute(attr || 'src', newVal);
                  if (tag === 'iframe') el.src = newVal;
                }
                saveToHistory();
              }
            }


            else if (choice === 'text') {
              const textInput = overlay.querySelector('#textInput');
              const newText = textInput.value.trim();
              
              if (newText !== null) {
                // Clear existing content and add new text
                el.innerHTML = '';
                el.appendChild(document.createTextNode(newText));
                saveToHistory();
              }
            }



            else if (choice === 'style') {
              const bgColorInput = overlay.querySelector('#bgColorInput');
              const textColorInput = overlay.querySelector('#textColorInput');
              const fontSizeInput = overlay.querySelector('#fontSizeInput');
              
              if (bgColorInput.value) {
                el.style.backgroundColor = bgColorInput.value;
              }
              if (textColorInput.value) {
                el.style.color = textColorInput.value;
              }
              if (fontSizeInput.value) {
                el.style.fontSize = fontSizeInput.value;
              }
              saveToHistory();
            }
            
            else if (choice === 'browse') {
              const imgInput = overlay.querySelector('#imgInput');
              const imageUrlInput = overlay.querySelector('#imageUrlInput');
              
              // Handle file upload
              if (imgInput.files && imgInput.files[0]) {
                const file = imgInput.files[0];
                const reader = new FileReader();
                reader.onloadend = async () => {
                  try {
                    const b64 = reader.result.split(',')[1];

                    // === 1. Delete previous image if needed ===
                    const prevFile = el.getAttribute('data-image-file');
                    if (prevFile) {
                      try {
                        const res = await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${prevFile}`, {
                          method: 'GET',
                          headers: { 'Authorization': `Bearer ${TOKEN}` }
                        });
                        if (res.ok) {
                          const data = await res.json();
                          const deleteRes = await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${prevFile}`, {
                            method: 'DELETE',
                            headers: {
                              'Authorization': `Bearer ${TOKEN}`,
                              'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                              message: `Delete old image ${prevFile}`,
                              sha: data.sha,
                              branch: BRANCH
                            })
                          });
                          if (!deleteRes.ok) throw new Error("Could not delete previous image");
                        }
                      } catch (err) {
                        console.warn("No previous image to delete or failed to delete:", err.message);
                      }
                    }

                    // === 2. Upload new image ===
                    const safeName = `img_${Date.now()}_${file.name.replace(/[^a-z0-9.\-_]/gi, '_').toLowerCase()}`;
                    const githubPath = `images/${safeName}`;

                    await apiCommit(githubPath, b64, `Upload image ${safeName}`);

                    // === 3. Apply new image and track it ===
                    el.setAttribute(attr || 'src', githubPath);
                    el.setAttribute('data-image-file', githubPath);

                    if (tag === 'img') el.src = githubPath;
                    setTimeout(() => attachAllHandlers(doc), 50);

                    alert(`✅ Uploaded and linked: ${githubPath}`);
                  } catch (err) {
                    alert('❌ Upload failed: ' + err.message);
                  }
                };
                reader.onerror = () => alert("❌ Could not read file.");
                reader.readAsDataURL(file);
              }
              
              // Handle URL input
              else if (imageUrlInput.value.trim()) {
                const imageUrl = imageUrlInput.value.trim();
                el.setAttribute(attr || 'src', imageUrl);
                if (tag === 'img') el.src = imageUrl;
                setTimeout(() => {
                  attachAllHandlers(doc);
                  saveToHistory();
                }, 50);
              }
            }



            else if (choice === 'dormant') {
              el.classList.add('dormant');
              el.classList.remove('dormant-revealed');
              if (attr) {
                el.setAttribute(`data-original-${attr}`, el.getAttribute(attr) || '');
                el.removeAttribute(attr);
              }
              if (el.innerText) {
                el.setAttribute('data-original-text', el.innerText);
                el.innerText = '';
              }
              saveToHistory();
            }

            else if (choice === 'restore') {
              el.classList.remove('dormant');
              el.classList.remove('dormant-revealed');
              const originalText = el.getAttribute('data-original-text');
              if (originalText) {
                el.innerText = originalText;
                el.removeAttribute('data-original-text');
              }

              const attrs = ['src', 'href', 'data-link', 'onclick'];
              attrs.forEach(attr => {
                const original = el.getAttribute(`data-original-${attr}`);
                if (original) {
                  el.setAttribute(attr, original);
                  el.removeAttribute(`data-original-${attr}`);
                }
              });
              saveToHistory();
            }

            else if (choice === 'googleform') {
              const googleFormUrlInput = overlay.querySelector('#googleFormUrlInput');
              const formUrl = googleFormUrlInput.value.trim();
              if (!formUrl) return;

              const embedUrl = formUrl.includes("embedded=true")
                ? formUrl
                : formUrl.replace('/viewform', '/viewform?embedded=true');

              // Create a new div container for the embed instead of using the existing element
              const newContainer = doc.createElement('div');
              newContainer.style.margin = '20px 0';
              newContainer.style.textAlign = 'center';
              
              // Insert the new container after the clicked element
              el.parentNode.insertBefore(newContainer, el.nextSibling);
              
              insertEditableEmbed(newContainer, embedUrl);
              
              // Add a visual indicator that the embed was added
              setTimeout(() => {
                newContainer.style.outline = '2px solid #28a745';
                newContainer.style.outlineOffset = '5px';
                setTimeout(() => {
                  newContainer.style.outline = '';
                  newContainer.style.outlineOffset = '';
                }, 2000);
              }, 100);
              saveToHistory();
            }

            else if (choice === 'removeform') {
              if (el.tagName === 'IFRAME') {
                el.remove();
                saveToHistory();
                return;
              }

              const iframe = el.querySelector('iframe');
              if (iframe) {
                iframe.remove();
                saveToHistory();
              } else {
                alert("⚠️ No embedded form found in this element.");
              }
            }


            else if (choice === 'youtube') {
              const youtubeUrlInput = overlay.querySelector('#youtubeUrlInput');
              const videoUrl = youtubeUrlInput.value.trim();
              if (!videoUrl) return;
              
              // Extract video ID from various YouTube URL formats
              let videoId = '';
              const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
                /youtube\.com\/v\/([^&\n?#]+)/
              ];
              
              for (const pattern of patterns) {
                const match = videoUrl.match(pattern);
                if (match) {
                  videoId = match[1];
                  break;
                }
              }
              
              if (!videoId) {
                alert('❌ Invalid YouTube URL. Please use a valid YouTube video link.');
                return;
              }
              
              const embedUrl = `https://www.youtube.com/embed/${videoId}`;
              
              // Create a new div container for the embed
              const newContainer = doc.createElement('div');
              newContainer.style.margin = '20px 0';
              newContainer.style.textAlign = 'center';
              
              // Insert the new container after the clicked element
              el.parentNode.insertBefore(newContainer, el.nextSibling);
              
              insertEditableEmbed(newContainer, embedUrl);
              
              // Add visual indicator
              setTimeout(() => {
                newContainer.style.outline = '2px solid #ff0000';
                newContainer.style.outlineOffset = '5px';
                setTimeout(() => {
                  newContainer.style.outline = '';
                  newContainer.style.outlineOffset = '';
                }, 2000);
              }, 100);
              saveToHistory();
            }
            
            else if (choice === 'copy') {
              const clonedElement = el.cloneNode(true);
              // Remove editor-specific attributes from clone
              clonedElement.removeAttribute('data-editor-attached');
              clonedElement.onclick = null;
              
              // Insert after the original element
              el.parentNode.insertBefore(clonedElement, el.nextSibling);
              
              // Add visual indicator
              setTimeout(() => {
                clonedElement.style.outline = '2px solid #28a745';
                clonedElement.style.outlineOffset = '5px';
                setTimeout(() => {
                  clonedElement.style.outline = '';
                  clonedElement.style.outlineOffset = '';
                }, 2000);
              }, 100);
              saveToHistory();
            }
            
            else if (choice === 'delete') {
              if (confirm('Are you sure you want to delete this element?')) {
                el.remove();
                saveToHistory();
              }
            }

            setTimeout(() => {
              attachAllHandlers(doc);
              showStatus('✅ Changes applied!', 2000, 'success');
            }, 100);
          };
        };
      });
    }






    function showDormantElements(show) {
      const doc = frame.contentDocument || frame.contentWindow.document;
      const dormantEls = doc.querySelectorAll('.dormant, .dormant-revealed');

      dormantEls.forEach(el => {
        if (show) {
          // Convert .dormant ➜ .dormant-revealed
          el.classList.remove('dormant');
          el.classList.add('dormant-revealed');

          // Restore text
          const text = el.getAttribute('data-original-text');
          if (text && el.innerText.trim() === '') {
            el.innerText = text;
          }

          // Restore src, href, etc
          const attrs = ['src', 'href', 'data-link', 'onclick'];
          attrs.forEach(attr => {
            const original = el.getAttribute(`data-original-${attr}`);
            if (original && !el.getAttribute(attr)) {
              el.setAttribute(attr, original);
            }
          });
        } else {
          // Convert .dormant-revealed ➜ .dormant
          el.classList.add('dormant');
          el.classList.remove('dormant-revealed');

          // Hide content (do NOT delete original values)
          el.innerText = '';
          const attrs = ['src', 'href', 'data-link', 'onclick'];
          attrs.forEach(attr => {
            if (el.hasAttribute(attr)) {
              el.removeAttribute(attr);
            }
          });
        }
      });

      attachAllHandlers(doc);
    }





    const dormantBtn = document.createElement('button');
    dormantBtn.textContent = "👁️ Show Dormant";
    dormantBtn.style.position = "fixed";
    dormantBtn.style.bottom = "100px";
    dormantBtn.style.right = "20px";
    dormantBtn.style.width = "130px";
    dormantBtn.style.height = "60px";
    dormantBtn.style.zIndex = "9999";
    dormantBtn.style.padding = "16px 20px";
    dormantBtn.style.background = "#000000";
    dormantBtn.style.color = "white";
    dormantBtn.style.border = "2px solid #dc3545";
    dormantBtn.style.cursor = "pointer";
    dormantBtn.style.fontWeight = "700";
    dormantBtn.style.boxShadow = "0 10px 30px rgba(0, 0, 0, 0.4)";
    dormantBtn.style.transition = "all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)";
    dormantBtn.style.backdropFilter = "blur(15px)";
    dormantBtn.style.textTransform = "uppercase";
    dormantBtn.style.letterSpacing = "0.5px";
    dormantBtn.style.overflow = "hidden";
    dormantBtn.style.animation = "slideIn 0.6s ease-out 0.4s both";
    dormantBtn.style.clipPath = "polygon(20% 0%, 80% 0%, 100% 50%, 80% 100%, 20% 100%, 0% 50%)";
    dormantBtn.style.transform = "rotate(0deg)";
    document.body.appendChild(dormantBtn);
    let dormantVisible = false;
    dormantBtn.onclick = () => {
      dormantVisible = !dormantVisible;
      showDormantElements(dormantVisible);
      dormantBtn.textContent = dormantVisible ? "🙈 Hide Dormant" : "👁️ Show Dormant";
    };


    async function apiCommit(path, contentB64, message) {
      let fileSha = undefined;

      try {
        // Always get the current SHA for the file we're committing
        const shaRes = await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${path}`, {
          headers: { 'Authorization': `Bearer ${TOKEN}` }
        });
        if (shaRes.ok) {
          const data = await shaRes.json();
          fileSha = data.sha;
        } else if (shaRes.status === 404) {
          // File doesn't exist yet, that's okay for new files
          fileSha = undefined;
        } else {
          throw new Error(`Failed to get file SHA: ${shaRes.status} ${shaRes.statusText}`);
        }

        const res = await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${path}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message,
            content: contentB64,
            sha: fileSha,
            branch: BRANCH
          })
        });

        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(`GitHub API error: ${errorData.message || res.statusText}`);
        }

        return await res.json();
      } catch (error) {
        console.error('API commit failed:', error);
        throw error;
      }
    }



    // Helper function to prepare HTML for iframe with CSS isolation
    function prepareIframeHTML(html) {
      // Add data attribute to prevent CSS conflicts
      html = html.replace('<html', '<html data-iframe-content="true"');
      html = html.replace('<body', '<body data-iframe-content="true"');
      
      // Add CSS reset to the iframe content to prevent inheritance
      const cssReset = `
        <style>
          html[data-iframe-content="true"], body[data-iframe-content="true"] {
            background: inherit !important;
            color: inherit !important;
            font-family: inherit !important;
            margin: inherit !important;
            padding: inherit !important;
            overflow: inherit !important;
            min-height: inherit !important;
          }
        </style>
      `;
      
      // Insert the CSS reset into the head
      if (html.includes('<head>')) {
        html = html.replace('<head>', '<head>' + cssReset);
      } else {
        html = html.replace('<html', '<html><head>' + cssReset + '</head>');
      }
      
      return html;
    }

    async function loadHTML() {
      try {
        const r = await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${FILE_PATH}`, { 
          headers: { 'Authorization': `Bearer ${TOKEN}` } 
        });
        
        if (!r.ok) {
          throw new Error(`Failed to load file: ${r.status} ${r.statusText}`);
        }
        
        const j = await r.json();
        let html = atob(j.content);
        sha = j.sha;
        
        // Prepare HTML for iframe with CSS isolation
        html = prepareIframeHTML(html);
        
        // Debug: Check if the HTML has a black background
        console.log('Loading HTML content:', html.substring(0, 500) + '...');
        
        frame.srcdoc = html;
      } catch (e) { 
        console.error('Load failed:', e);
        alert('Load failed: ' + e.message);
      }
    }


    frame.onload = () => {
      const doc = frame.contentDocument;
      console.log('Frame loaded, setting up handlers...');
      
      // Debug: Check iframe background
      const computedStyle = window.getComputedStyle(doc.body);
      console.log('Iframe body background:', computedStyle.backgroundColor);
      console.log('Iframe body color:', computedStyle.color);
      
      doc._iframeSpaceHeld = false;
      upgradeAllIframes(doc);
      doc.addEventListener('keydown', ev => { if (ev.code === 'Space') doc._iframeSpaceHeld = true; });
      doc.addEventListener('keyup', ev => { if (ev.code === 'Space') doc._iframeSpaceHeld = false; });
      showDormantElements(dormantVisible);
      attachAllHandlers(doc);
      console.log('Frame setup complete');
      
      // Initialize history with current state
      setTimeout(() => initializeHistory(), 100);
      
      // Start auto-save
      startAutoSave();
      showStatus('🚀 Editor ready!', 2000, 'success');
    };



    
    function saveWorkWithLabel() {
      try {
        const label = document.getElementById('saveWorkLabel').value.trim();
        if (!label) {
          showStatus('❌ Please enter a label', 2000, 'error');
          return;
        }
        
        const doc = frame.contentDocument || frame.contentWindow.document;
        const htmlContent = doc.documentElement.outerHTML;
        
        // Handle preview mode
        if (isPreviewMode) {
          // Activate the preview content
          isPreviewMode = false;
          previewFilename = null;
          originalContent = null;
          
          // Remove preview indicator
          const indicator = document.getElementById('previewIndicator');
          if (indicator) {
            indicator.remove();
          }
          
          showStatus(`✅ Preview activated and saved as "${label}"!`, 3000, 'success');
        }
        
        // Save to localStorage as temporary work
        const saveKey = `temp_work_${FILE_PATH}_${Date.now()}`;
        const saveData = {
          html: htmlContent,
          timestamp: Date.now(),
          filename: FILE_PATH,
          description: label
        };
        
        localStorage.setItem(saveKey, JSON.stringify(saveData));
        
        // Close popup safely
        const popups = document.querySelectorAll('.edit-overlay, .edit-backdrop');
        popups.forEach(el => {
          if (el && el.parentNode) {
            el.remove();
          }
        });
        
        // Show success message
        const message = isPreviewMode ? 
          `✅ Preview activated and saved as "${label}"!` : 
          `💾 Work saved as "${label}"! (Not published to web)`;
        showStatus(message, 3000, 'success');
        
      } catch (error) {
        console.error('Save work error:', error);
        showStatus('❌ Failed to save work', 3000, 'error');
      }
    }

    // Save version to GitHub as separate file
    async function saveVersionToGitHub() {
      try {
        console.log('saveVersionToGitHub called');
        const labelInput = document.getElementById('versionLabel');
        const descriptionInput = document.getElementById('versionDescription');
        
        if (!labelInput) {
          console.error('versionLabel input not found');
          showStatus('❌ Version label input not found', 3000, 'error');
          return;
        }
        
        if (!descriptionInput) {
          console.error('versionDescription input not found');
          showStatus('❌ Version description input not found', 3000, 'error');
          return;
        }
        
        const label = labelInput.value.trim();
        const description = descriptionInput.value.trim();
        
        console.log('Label:', label);
        console.log('Description:', description);
        
        if (!label) {
          showStatus('❌ Please enter a version label', 2000, 'error');
          return;
        }
        
        console.log('Label validation passed');
        
        // Show loading state
        showStatus('⏳ Saving version...', 0, 'info');
        
        // Get current HTML content
        const doc = frame.contentDocument || frame.contentWindow.document;
        if (!doc) {
          console.error('Frame document not found');
          showStatus('❌ Frame document not found', 3000, 'error');
          return;
        }
        
        const htmlContent = doc.documentElement.outerHTML;
        console.log('Got HTML content, length:', htmlContent.length);
        
        // Clean HTML for version save (remove editor-specific elements)
        const cleanDoc = doc.cloneNode(true);
        
        // Remove editor-specific elements
        cleanDoc.querySelectorAll('[data-editor-attached]').forEach(el => {
          el.removeAttribute('data-editor-attached');
        });
        
        // Remove edit buttons and convert wrapped iframes back to simple iframes
        cleanDoc.querySelectorAll('div[style*="position: relative"]').forEach(wrapper => {
          const iframe = wrapper.querySelector('iframe');
          const editButton = wrapper.querySelector('button');
          
          if (iframe) {
            // Get the wrapper's dimensions
            const width = wrapper.style.width || '100%';
            const height = wrapper.style.height || '500px';
            
            // Apply dimensions to iframe
            iframe.style.width = width;
            iframe.style.height = height;
            iframe.style.border = 'none';
            
            // Replace wrapper with iframe
            wrapper.parentNode.insertBefore(iframe, wrapper);
            wrapper.remove();
          }
        });
        
        // Hide dormant elements in version
        cleanDoc.querySelectorAll('.dormant, .dormant-revealed').forEach(el => {
          el.style.display = 'none';
        });
        
        const cleanHtml = cleanDoc.documentElement.outerHTML;
        
        // Create version filename
        const baseName = FILE_PATH.replace('.html', '');
        const versionFileName = `${baseName}-${label}.html`;
        console.log('Version filename:', versionFileName);
        
        // Prepare commit message
        const commitMessage = description 
          ? `Save version: ${label}\n\n${description}`
          : `Save version: ${label}`;
        console.log('Commit message:', commitMessage);
        
        console.log('Making GitHub API call...');
        // Get current SHA for the branch
        const branchResponse = await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/branches/${BRANCH}`, {
          headers: {
            'Authorization': `token ${TOKEN}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        console.log('Branch response status:', branchResponse.status);
        if (!branchResponse.ok) {
          const errorText = await branchResponse.text();
          console.error('Branch response error:', errorText);
          throw new Error('Failed to get branch information');
        }
        
        const branchData = await branchResponse.json();
        const sha = branchData.commit.sha;
        console.log('Got branch SHA:', sha);
        
        console.log('Creating file on GitHub...');
        // Create the new file
        const createResponse = await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${versionFileName}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${TOKEN}`,
            'Content-Type': 'application/json',
            'Accept': 'application/vnd.github.v3+json'
          },
          body: JSON.stringify({
            message: commitMessage,
            content: btoa(unescape(encodeURIComponent(cleanHtml))),
            branch: BRANCH
          })
        });
        
        console.log('Create response status:', createResponse.status);
        if (!createResponse.ok) {
          const errorData = await createResponse.json();
          console.error('Create response error:', errorData);
          throw new Error(`GitHub API error: ${errorData.message || 'Unknown error'}`);
        }
        
        console.log('Version saved successfully!');
        // Close popup
        closePopup();
        
        // Show success message
        showStatus(`📁 Version saved as "${versionFileName}"!`, 4000, 'success');
        
      } catch (error) {
        console.error('Save version error:', error);
        showStatus(`❌ Failed to save version: ${error.message}`, 4000, 'error');
      }
    }



    // Fetch available versions from GitHub
    async function fetchAvailableVersions() {
      try {
        const response = await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents`, {
          headers: {
            'Authorization': `token ${TOKEN}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (!response.ok) {
          throw new Error('Failed to fetch repository contents');
        }
        
        const contents = await response.json();
        const baseName = FILE_PATH.replace('.html', '');
        
        // Filter for version files (files that match the pattern: baseName-*.html)
        const versionFiles = contents.filter(item => 
          item.type === 'file' && 
          item.name.startsWith(baseName + '-') && 
          item.name.endsWith('.html')
        );
        
        // Get commit information for each version
        const versionsWithInfo = await Promise.all(
          versionFiles.map(async (file) => {
            try {
              const commitResponse = await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/commits?path=${file.name}&per_page=1`, {
                headers: {
                  'Authorization': `token ${TOKEN}`,
                  'Accept': 'application/vnd.github.v3+json'
                }
              });
              
              if (commitResponse.ok) {
                const commits = await commitResponse.json();
                const commit = commits[0];
                return {
                  name: file.name,
                  commitMessage: commit.commit.message,
                  lastModified: commit.commit.author.date,
                  sha: commit.sha
                };
              }
              
              return {
                name: file.name,
                commitMessage: 'No commit message available',
                lastModified: new Date().toISOString(),
                sha: null
              };
            } catch (error) {
              return {
                name: file.name,
                commitMessage: 'Error loading commit info',
                lastModified: new Date().toISOString(),
                sha: null
              };
            }
          })
        );
        
        return versionsWithInfo.sort((a, b) => new Date(b.lastModified) - new Date(a.lastModified));
        
      } catch (error) {
        console.error('Fetch versions error:', error);
        throw error;
      }
    }

    // Global variables for preview state
    let isPreviewMode = false;
    let previewFilename = null;
    let originalContent = null;

    // Load a specific version from GitHub as preview
    async function loadVersionPreview(filename) {
      try {
        // Show loading state
        showStatus('⏳ Loading preview...', 0, 'info');
        
        const response = await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${filename}`, {
          headers: {
            'Authorization': `token ${TOKEN}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (!response.ok) {
          throw new Error('Failed to fetch version file');
        }
        
        const fileData = await response.json();
        const htmlContent = atob(fileData.content);
        
        // Store original content if not already stored
        if (!originalContent) {
          const doc = frame.contentDocument || frame.contentWindow.document;
          originalContent = doc.documentElement.outerHTML;
        }
        
        // Load the version content into the frame as preview
        let htmlContentWithAttr = prepareIframeHTML(htmlContent);
        frame.srcdoc = htmlContentWithAttr;
        
        frame.onload = () => {
          const doc = frame.contentDocument || frame.contentWindow.document;
          attachAllHandlers(doc);
          showDormantElements(dormantVisible);
          
          // Set preview mode
          isPreviewMode = true;
          previewFilename = filename;
          
          // Reset history for the new content
          initializeHistory();
          
          showStatus(`👁️ Preview loaded: ${filename} (Save/Publish to activate)`, 5000, 'info');
          
          // Add preview indicator
          addPreviewIndicator();
          
          // Visual feedback
          const settingsBtn = document.getElementById('helpBtn');
          settingsBtn.style.transform = 'scale(1.1)';
          settingsBtn.style.boxShadow = '0 15px 40px rgba(255, 107, 107, 0.6)';
          setTimeout(() => {
            settingsBtn.style.transform = '';
            settingsBtn.style.boxShadow = '';
          }, 300);
        };
        
      } catch (error) {
        console.error('Load preview error:', error);
        showStatus(`❌ Failed to load preview: ${error.message}`, 4000, 'error');
      }
    }

    // Load a specific version from GitHub (original function for direct replacement)
    async function loadVersionFromGitHub(filename) {
      try {
        // Show loading state
        showStatus('⏳ Loading version...', 0, 'info');
        
        const response = await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${filename}`, {
          headers: {
            'Authorization': `token ${TOKEN}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (!response.ok) {
          throw new Error('Failed to fetch version file');
        }
        
        const fileData = await response.json();
        const htmlContent = atob(fileData.content);
        
        // Load the version content into the frame
        let htmlContentWithAttr = prepareIframeHTML(htmlContent);
        frame.srcdoc = htmlContentWithAttr;
        
        frame.onload = () => {
          const doc = frame.contentDocument || frame.contentWindow.document;
          attachAllHandlers(doc);
          showDormantElements(dormantVisible);
          
          // Reset history for the new content
          initializeHistory();
          
          showStatus(`✅ Loaded version: ${filename}`, 3000, 'success');
          
          // Visual feedback
          const settingsBtn = document.getElementById('helpBtn');
          settingsBtn.style.transform = 'scale(1.1)';
          settingsBtn.style.boxShadow = '0 15px 40px rgba(253, 126, 20, 0.6)';
          setTimeout(() => {
            settingsBtn.style.transform = '';
            settingsBtn.style.boxShadow = '';
          }, 300);
        };
        
      } catch (error) {
        console.error('Load version error:', error);
        showStatus(`❌ Failed to load version: ${error.message}`, 4000, 'error');
      }
    }

    // Delete a version from GitHub
    async function deleteVersionFromGitHub(filename) {
      try {
        // Show loading state
        showStatus('🗑️ Deleting version...', 0, 'info');
        
        // Get the file's current SHA
        const response = await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${filename}`, {
          headers: {
            'Authorization': `token ${TOKEN}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (!response.ok) {
          throw new Error('Failed to fetch file information');
        }
        
        const fileData = await response.json();
        
        // Delete the file
        const deleteResponse = await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${filename}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `token ${TOKEN}`,
            'Content-Type': 'application/json',
            'Accept': 'application/vnd.github.v3+json'
          },
          body: JSON.stringify({
            message: `Delete version: ${filename}`,
            sha: fileData.sha
          })
        });
        
        if (!deleteResponse.ok) {
          const errorData = await deleteResponse.json();
          throw new Error(`GitHub API error: ${errorData.message || 'Unknown error'}`);
        }
        
        showStatus(`🗑️ Deleted version: ${filename}`, 3000, 'success');
        
      } catch (error) {
        console.error('Delete version error:', error);
        showStatus(`❌ Failed to delete version: ${error.message}`, 4000, 'error');
      }
    }

    // Publish to Web functionality
    const publishBtn = document.getElementById('publishBtn');
    let isPublishing = false; // Prevent multiple rapid clicks
    
    publishBtn.onclick = async () => {
      // Prevent multiple rapid clicks
      if (isPublishing) {
        showStatus('⚠️ Already publishing, please wait...', 2000, 'warning');
        return;
      }
      
      isPublishing = true;
      try {
        // Show loading state
        const originalText = publishBtn.textContent;
        const spinner = publishBtn.querySelector('.spinner');
        const commitStatus = document.getElementById('commitStatus');
        
        publishBtn.textContent = '⏳ Committing...';
        publishBtn.disabled = true;
        if (spinner) {
          spinner.style.display = 'inline-block';
        }
        commitStatus.style.display = 'block';
        
        // Start progress animation
        showProgress(25);
        showStatus('🔄 Preparing changes...', 0, 'info');
        
        const doc = frame.contentDocument || frame.contentWindow.document;

        // 🔍 Temporarily show all dormant content
        const dormantEls = doc.querySelectorAll('.dormant, .dormant-revealed');
        dormantEls.forEach(el => {
          if (el.classList.contains('dormant-revealed')) {
            el.classList.remove('dormant-revealed');
            el.classList.add('dormant');
          }
        });

        // 🔐 Clean HTML for commit (remove editor-specific elements)
        const cleanDoc = doc.cloneNode(true);
        
        // ✅ Ensure all necessary styles are injected
        const requiredStyles = `
    .dormant {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
      height: 0 !important;
      width: 0 !important;
      overflow: hidden !important;
    }
    .dormant-revealed {
      opacity: 0.3 !important;
      pointer-events: auto !important;
      outline: 2px dotted #e67e22 !important;
      background: #fffbe6 !important;
      color: #e67e22 !important;
      cursor: pointer !important;
    }
    .editable-form-embed {
      width: 100% !important;
      height: 500px;
      display: block;
      border: none;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    .iframe-wrapper {
      position: relative;
      display: inline-block;
      overflow: hidden;
    }
    .iframe-overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: transparent;
      z-index: 1000;
      cursor: pointer;
    }`;
        
        const head = cleanDoc.querySelector('head');
        if (head) {
          // Remove any existing editor styles
          cleanDoc.querySelectorAll('style[data-dormant], style[data-editor]').forEach(el => el.remove());
          
          // Add fresh styles
          const style = cleanDoc.createElement('style');
          style.setAttribute('data-editor', 'yes');
          style.textContent = requiredStyles;
          head.appendChild(style);
        }
        
        // Clean up editor-specific elements and convert back to simple iframes
        cleanDoc.querySelectorAll('[data-editor-attached]').forEach(el => {
          el.removeAttribute('data-editor-attached');
        });
        
        // Remove edit buttons and convert wrapped iframes back to simple iframes
        cleanDoc.querySelectorAll('div[style*="position: relative"]').forEach(wrapper => {
          const iframe = wrapper.querySelector('iframe');
          const editButton = wrapper.querySelector('button');
          
          if (iframe) {
            // Get the wrapper's dimensions
            const width = wrapper.style.width || '100%';
            const height = wrapper.style.height || '500px';
            
            // Apply dimensions to iframe
            iframe.style.width = width;
            iframe.style.height = height;
            iframe.style.border = 'none';
            iframe.style.display = 'block';
            iframe.style.margin = '0 auto';
            iframe.style.boxSizing = 'border-box';
            iframe.style.maxWidth = '100%';
            
            // Remove edit button
            if (editButton) {
              editButton.remove();
            }
            
            // Move iframe out of wrapper and remove wrapper
            wrapper.parentNode.insertBefore(iframe, wrapper);
            wrapper.remove();
          }
        });
        

        

        
        // Final cleanup: Remove any remaining editor-specific styles from iframes
        cleanDoc.querySelectorAll('iframe').forEach(iframe => {
          // Remove any editor-specific inline styles
          iframe.style.outline = '';
          iframe.style.transition = '';
          iframe.style.zIndex = '';
          iframe.style.pointerEvents = '';
          
          // Ensure clean styling
          iframe.style.border = 'none';
          iframe.style.display = 'block';
          iframe.style.margin = '0 auto';
          iframe.style.boxSizing = 'border-box';
          iframe.style.maxWidth = '100%';
        });
        
        // Handle preview mode
        if (isPreviewMode) {
          // Activate the preview content
          isPreviewMode = false;
          previewFilename = null;
          originalContent = null;
          
          // Remove preview indicator
          const indicator = document.getElementById('previewIndicator');
          if (indicator) {
            indicator.remove();
          }
          
          showStatus('✅ Preview activated and publishing...', 0, 'info');
        }
        
        // 🔐 Serialize and commit cleaned HTML
        showProgress(75);
        showStatus('💾 Uploading to GitHub...', 0, 'info');
        
        const newHTML = cleanDoc.documentElement.outerHTML;
        const enc = btoa(unescape(encodeURIComponent(newHTML)));
        await apiCommit(FILE_PATH, enc, 'Commit from editor');
        
        // 🔄 Reload content and restore view
        showProgress(90);
        showStatus('🔄 Reloading content...', 0, 'info');
        await loadHTML();
        
        // Show success
        showProgress(100);
        const successMessage = isPreviewMode ? 
          '✅ Preview activated and successfully published!' : 
          '✅ Successfully committed!';
        showStatus(successMessage, 3000, 'success');
        commitStatus.style.display = 'none';
        publishBtn.textContent = '✅ Committed!';
        if (spinner) {
          spinner.style.display = 'none';
        }
        setTimeout(() => {
          publishBtn.textContent = originalText;
          publishBtn.disabled = false;
          isPublishing = false; // Reset flag
        }, 2000);
      } catch (e) {
        console.error('Commit failed:', e);
        alert('Commit failed: ' + e.message);
        
        // Restore button state
        showProgress(0);
        showStatus('❌ Commit failed!', 3000, 'error');
        commitStatus.style.display = 'none';
        if (spinner) {
          spinner.style.display = 'none';
        }
        publishBtn.textContent = originalText;
        publishBtn.disabled = false;
        isPublishing = false; // Reset flag
      }
    };



    // Initialize page selector and load initial page
    initializePageSelector();
    loadHTML();
    
    // Check for saved work and offer to restore it after a short delay
    // DISABLED: This was causing the page to go dark after loading
    // setTimeout(() => {
    //   const savedWork = [];
    //   for (let i = 0; i < localStorage.length; i++) {
    //     const key = localStorage.key(i);
    //     if (key && key.startsWith('temp_work_') && key.includes(FILE_PATH)) {
    //       try {
    //         const data = JSON.parse(localStorage.getItem(key));
    //         savedWork.push({
    //           key: key,
    //           ...data
    //         });
    //       } catch (e) {
    //         console.error('Error parsing saved work:', e);
    //       }
    //     }
    //   }
    //   
    //   // If there's saved work, offer to restore it
    //   if (savedWork.length > 0) {
    //     savedWork.sort((a, b) => b.timestamp - a.timestamp);
    //     const mostRecent = savedWork[0];
    //     
    //     const overlay = document.createElement('div');
    //     overlay.className = 'edit-overlay';
    //     const backdrop = document.createElement('div');
    //     backdrop.className = 'edit-backdrop';
    //     
    //     overlay.innerHTML = `
    //       <h3>💾 Restore Saved Work?</h3>
    //       <p>Found saved work from ${new Date(mostRecent.timestamp).toLocaleString()}</p>
    //       <p><strong>${mostRecent.description}</strong></p>
    //       <div class="button-group">
    //         <button onclick="restoreSavedWork('${mostRecent.key}')" class="primary">Restore</button>
    //         <button onclick="this.closest('.edit-overlay').remove(); this.closest('.edit-backdrop').remove();" class="secondary">Start Fresh</button>
    //       </div>
    //     `;
    //     
    //     document.body.append(backdrop, overlay);
    //     
    //     backdrop.onclick = () => {
    //       overlay.remove();
    //       backdrop.remove();
    //     };
    //   }
    // }, 1000);
    
    function restoreSavedWork(key) {
      try {
        const data = JSON.parse(localStorage.getItem(key));
        if (data && data.html) {
          let htmlWithAttr = prepareIframeHTML(data.html);
          frame.srcdoc = htmlWithAttr;
          frame.onload = () => {
            const doc = frame.contentDocument || frame.contentWindow.document;
            attachAllHandlers(doc);
            showStatus('💾 Restored saved work!', 3000, 'success');
          };
          
          // Close the dialog
          document.querySelectorAll('.edit-overlay, .edit-backdrop').forEach(el => el.remove());
        }
      } catch (error) {
        console.error('Error restoring saved work:', error);
        showStatus('❌ Failed to restore saved work', 3000, 'error');
      }
    }

    // === AUTO-APPLY ANIMATION OVERRIDE TO ALL .edit-overlay POPUPS ===
    (function() {
      const applyNoAnimation = (el) => {
        if (el && el.classList && el.classList.contains('edit-overlay')) {
          el.style.animation = 'none !important';
          el.style.transition = 'none !important';
        }
      };
      // Apply to any existing overlays
      document.querySelectorAll('.edit-overlay').forEach(applyNoAnimation);
      // Watch for new overlays
      const observer = new MutationObserver((mutations) => {
        for (const mutation of mutations) {
          for (const node of mutation.addedNodes) {
            if (node.nodeType === 1) {
              if (node.classList && node.classList.contains('edit-overlay')) {
                applyNoAnimation(node);
              }
              // Also check children
              node.querySelectorAll && node.querySelectorAll('.edit-overlay').forEach(applyNoAnimation);
            }
          }
        }
      });
      observer.observe(document.body, { childList: true, subtree: true });
    })();

  </script>
</body>

</html>
